<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="frame-src 'self' https://docs.google.com https://drive.google.com;">
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=1.0, viewport-fit=cover">-->
  <title>Enhanced HSE Inspection Report System</title>
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ‘·</text></svg>">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>

    .observation-card .card-img-top {
      cursor: pointer;
      max-height: 180px;
      object-fit: cover;
      border-top-left-radius: var(--bs-card-inner-border-radius);
      border-top-right-radius: var(--bs-card-inner-border-radius);
    }


    .observation-card .card-body {
      max-height: 300px; /* Adjust this value as needed */
      overflow-y: auto;
    }

    /* Fullscreen Image Modal Styling */
    #imageModal.modal.fade.show {
      background-color: rgba(0, 0, 0, 0.5);
    }

    #imageModal .modal-content {
      background-color: transparent;
      border: none;
    }

    #imageModal .modal-body {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      height: 100vh;
    }

    #imageModal #expandedImage {
      max-height: 95vh;
      max-width: 95vw;
      object-fit: contain;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://gdpgqqsadpsqabcnklbt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdkcGdxcXNhZHBzcWFiY25rbGJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwODYzMjIsImV4cCI6MjA3MTY2MjMyMn0.s-7xVhFZ6N89AtaXtIr4lA6oSgY39DPYgsK7-lK76aw';
    
    // Initialize Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // --- Global Helper Functions ---

  // Helper function to determine badge color based on risk level
  function getRiskColor(risk) {
    if (!risk) return 'secondary';
    switch (risk.toLowerCase()) {
      case 'high': return 'danger';
      case 'medium': return 'warning';
      default: return 'success';
    }
  }
    // Handles showing the observation details modal
        // Observation Detail Modal Instance
    let observationModalInstance = null;
    document.addEventListener('DOMContentLoaded', () => {
      const modalElement = document.getElementById('observationDetailModal');
      if (modalElement) {
        observationModalInstance = new bootstrap.Modal(modalElement);
      }
    });

    window.viewObservation = function(observationId) {
      const observation = (window.allObservations || []).find(obs => obs.id === observationId);
      if (!observation) {
        console.error('Observation not found:', observationId);
        alert('Could not find the details for this observation.');
        return;
      }

      // Populate modal fields
      // Safely populate modal fields
      const fields = {
        'modalLocation': observation.location || 'N/A',
        'modalDate': observation.date ? new Date(observation.date).toLocaleDateString() : 'N/A',
        'modalResponsible': observation.responsible || 'N/A',
        'modalInspector': observation.inspector || 'N/A',
        'modalObservationText': observation.observation || 'N/A',
        'modalActionTaken': observation.actionTaken || 'N/A'
      };

      for (const id in fields) {
        const el = document.getElementById(id);
        if (el) el.textContent = fields[id];
      }

      const riskEl = document.getElementById('modalRisk');
      if (riskEl) riskEl.innerHTML = `<span class="badge bg-${getRiskColor(observation.risk)}">${observation.risk} Risk</span>`;

      // Populate photos
      const photoContainer = document.getElementById('modalPhotos');
      if (photoContainer) {
        photoContainer.innerHTML = ''; // Clear previous photos
        if (observation.photos && observation.photos.length > 0) {
          observation.photos.forEach(photoUrl => {
            const photoEl = `
              <div class="col-md-4 mb-3">
                <a href="${photoUrl}" target="_blank" title="View full image">
                  <img src="${photoUrl}" class="img-fluid rounded" alt="Observation photo">
                </a>
              </div>
            `;
            photoContainer.innerHTML += photoEl;
          });
        } else {
          photoContainer.innerHTML = '<div class="col-12"><p class="text-muted">No photos for this observation.</p></div>';
        }
      }

      // Show the modal
      if (observationModalInstance) {
        observationModalInstance.show();
      } else {
        console.error('Observation modal instance not initialized.');
      }
    }

    // Supabase helper functions
    async function testConnection() {
      try {
        console.log('Testing Supabase connection...');
        const { data, error } = await supabase.from('assessors').select('count', { count: 'exact', head: true });
        
        if (error) {
          if (error.code === 'PGRST116') {
            console.log('âœ… Connection successful! Tables need to be created.');
            alert('Supabase connected! Please run the SQL schema in your dashboard.');
            return { connected: true, tablesExist: false };
          } else {
            console.error('Connection error:', error);
            return { connected: false, error };
          }
        } else {
          console.log('âœ… Connection successful! Tables exist.');
          return { connected: true, tablesExist: true };
        }
      } catch (err) {
        console.error('Connection test failed:', err);
        return { connected: false, error: err };
      }
    }
    
    // Test connection on page load
    window.addEventListener('DOMContentLoaded', async () => {
      const result = await testConnection();
      if (result.connected && !result.tablesExist) {
        console.log('Ready to create tables - run the SQL schema in Supabase dashboard');
      }
    });
    
    // Backward compatibility aliases for existing code
    const FieldValue = { serverTimestamp: () => new Date().toISOString() };
    
    // Auth wrapper for Supabase
    const auth = {
      get currentUser() {
        return supabase.auth.getUser().then(({ data: { user } }) => user);
      },
      onAuthStateChanged: (callback) => {
        return supabase.auth.onAuthStateChange((event, session) => {
          callback(session?.user || null);
        });
      },
      signOut: () => supabase.auth.signOut()
    };
    
    // User state
    let currentUser = null;
    
    // API base (adjust if server port/origin differs)
    const API_BASE = 'http://localhost:4000';
    
    // Generic helpers
    async function apiGet(path) {
      const res = await fetch(`${API_BASE}${path}`);
      if (!res.ok) throw new Error(`GET ${path} failed`);
      return res.json();
    }
    async function apiSend(path, method, body) {
      const res = await fetch(`${API_BASE}${path}`, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body || {})
      });
      if (!res.ok) throw new Error(`${method} ${path} failed`);
      return res.json();
    }
    async function uploadImage(file) {
      const fd = new FormData();
      fd.append('file', file);
      const res = await fetch(`${API_BASE}/api/upload`, { method: 'POST', body: fd });
      if (!res.ok) throw new Error('Image upload failed');
      return res.json(); // { filename, path, url }
    }
    
    // Backend removed: authentication state handling removed
    
    // Backend removed: Firestore form submission removed
    // Update user profile in sidebar
    function updateUserProfile(user) {
      const userProfile = document.getElementById('userProfile');
      const userAvatar = document.getElementById('userAvatar');
      const userName = document.getElementById('userName');
      
      // Check if all required elements exist
      if (!userProfile || !userAvatar || !userName) return;
      
      if (user) {
        // Check if the user's email is one of the specified emails to use custom avatar
        const allowedEmails = ['niwael1995@gmail.com', 'niwamanyaelius95@gmail.com'];
        if (user.email && allowedEmails.includes(user.email.toLowerCase())) {
          userAvatar.src = 'Elius.jpg';
        } else {
          userAvatar.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%236c757d"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
        }
        userName.textContent = user.displayName || user.email?.split('@')[0] || 'User';
        userProfile.style.display = 'flex';
      } else {
        userProfile.style.display = 'none';
      }
    }
    
    // Enable all tabs after successful authentication
    function enableAllTabs() {
      const tabs = document.querySelectorAll('.nav-link');
      tabs.forEach(tab => {
        tab.classList.remove('tab-disabled');
        tab.removeAttribute('disabled');
      });
      
      // Backend removed: guard absent elements
      const uc = document.getElementById('userControls');
      if (uc) uc.style.display = 'block';
      const sideMenu = document.getElementById('hseTabs');
      if (sideMenu) sideMenu.style.display = 'flex';
      const content = document.getElementById('hseTabContent');
      if (content) content.style.display = 'block';
      // Hide full-screen auth overlay
      const authPage = document.getElementById('authPage');
      if (authPage) authPage.style.display = 'none';
    }
    
    // Disable all tabs except auth tab
    function disableAllTabs() {
      const tabs = document.querySelectorAll('.nav-link');
      tabs.forEach(tab => {
        tab.classList.add('tab-disabled');
        tab.setAttribute('disabled', 'disabled');
      });
      
      // Backend removed: guard absent elements
      const uc2 = document.getElementById('userControls');
      if (uc2) uc2.style.display = 'none';
      const sideMenu2 = document.getElementById('hseTabs');
      if (sideMenu2) sideMenu2.style.display = 'none';
      const content2 = document.getElementById('hseTabContent');
      if (content2) content2.style.display = 'none';
      // Show full-screen auth overlay
      const authPage = document.getElementById('authPage');
      if (authPage) authPage.style.display = 'block';
    }
    
    // Advanced Sign out function with instant feedback (local only)
    function signOut() {
      const logoutBtn = document.querySelector('.logout-btn');
      if (logoutBtn) {
        logoutBtn.disabled = true;
        logoutBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`;
      }

      try {
        // Clear user data
        localStorage.removeItem('assessorData');
        currentUser = null;

        // Reset UI
        const authContainer = document.getElementById('authContainer');
        const assessorManagement = document.getElementById('assessorManagement');
        if (authContainer) authContainer.style.display = 'block';
        if (assessorManagement) assessorManagement.style.display = 'none';
        const assessorForm = document.getElementById('assessorForm');
        if (assessorForm) assessorForm.reset();
        updateUserProfile(null);

        // Disable all tabs
        const tabs = document.querySelectorAll('.nav-link:not(#assessor-tab)');
        tabs.forEach(tab => tab.classList.add('tab-disabled'));

        // Switch to Assessor tab
        const assessorTabEl = document.getElementById('assessor-tab');
        if (assessorTabEl) new bootstrap.Tab(assessorTabEl).show();

        // Show confirmation and reset button
        const toastEl = document.getElementById('logoutToast');
        if (toastEl) new bootstrap.Toast(toastEl).show();
        if (logoutBtn) {
          logoutBtn.disabled = false;
          logoutBtn.innerHTML = 'Logout';
        }
      } catch (error) {
        console.error('Sign out error:', error);
        if (logoutBtn) {
          logoutBtn.disabled = false;
          logoutBtn.innerHTML = 'Logout';
        }
        alert('Failed to log out. Please try again.');
      }
    }
    
    // Convert file to Base64
    function convertToBase64(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
      });
    }
    
    // Upload photos to Supabase Storage and return download URLs
    async function processPhotos(files) {
      return await Promise.all(
        Array.from(files).map(async (file) => {
          try {
            const fileName = `${Date.now()}_${file.name}`;
            const filePath = `inspections/${fileName}`;
            
            // Upload file to Supabase Storage
            const { data, error } = await supabase.storage
              .from('inspection-photos')
              .upload(filePath, file, {
                cacheControl: '3600',
                upsert: false
              });

            if (error) {
              console.error('Supabase Storage error:', error);
              throw error;
            }

            // Get public URL for the uploaded file
            const { data: { publicUrl } } = supabase.storage
              .from('inspection-photos')
              .getPublicUrl(filePath);
            
            const photoData = {
              name: file.name,
              url: publicUrl,
              path: filePath,
              size: (file.size / (1024 * 1024)).toFixed(2) + 'MB'
            };
            
            console.log('Storing photo data:', photoData);
            return photoData;
          } catch (error) {
            console.error('Error uploading file:', error);
            // Fallback to base64 if storage fails
            const base64 = await fileToBase64(file);
            return {
              name: file.name,
              url: base64,
              size: (file.size / (1024 * 1024)).toFixed(2) + 'MB',
              fallback: true
            };
          }
        })
      );
    }

    function fileToBase64(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
      });
    }
    
    // Save assessor information to Supabase
    async function saveAssessorInfo() {
      try {
        const assessorName = document.getElementById('assessorName').value.trim();
        const assessorId = document.getElementById('assessorId').value.trim();

        // Validate required fields
        if (!assessorName || !assessorId) {
          alert('Assessor Name and Assessor ID are required to continue.');
          return;
        }

        const assessorData = {
          name: assessorName,
          assessor_id: assessorId,
          department: document.getElementById('department').value,
          certification: document.getElementById('certification').value,
          email: assessorId + '@company.com', // Generate email from ID
          created_at: new Date().toISOString()
        };
        
        // Save to Supabase database
        const { data, error } = await supabase
          .from('assessors')
          .upsert(assessorData, { 
            onConflict: 'assessor_id',
            returning: 'minimal'
          });

        if (error) {
          console.error('Supabase error:', error);
          showNotification('Failed to save profile: ' + error.message, 'danger');
          return;
        }
        showNotification('Profile saved successfully to database!', 'success');
        
        // Update UI
        currentUser = assessorData;
        updateUserProfile(currentUser);
        enableAllTabs();
        updateInspectorDropdown(assessorData.name);
        
      } catch (error) {
        console.error("Save error:", error);
        showNotification('Failed to save profile: ' + error.message, 'danger');
      }
    }
    
    // Global variables for observation data and filters
    let allObservations = [];
    let filteredObservations = [];
    
    // Function to apply filters and re-render observations
    window.applyFilters = function() {
      const term = document.getElementById('searchObservations').value.trim().toLowerCase();
      const highEl = document.getElementById('highRiskFilter');
      const medEl = document.getElementById('mediumRiskFilter');
      const lowEl = document.getElementById('lowRiskFilter');
      const dateEl = document.getElementById('dateRangeFilter');
      
      let allowHigh = highEl ? highEl.checked : true;
      let allowMed = medEl ? medEl.checked : true;
      let allowLow = lowEl ? lowEl.checked : true;
      // If none selected, show all by default
      if (highEl || medEl || lowEl) {
        const noneSelected = !allowHigh && !allowMed && !allowLow;
        if (noneSelected) {
          allowHigh = allowMed = allowLow = true;
        }
      }
      const range = dateEl ? dateEl.value : 'all';
      
      const source = Array.isArray(window.allObservations) ? window.allObservations : [];
      let result = source.filter(o => {
        const r = (o && o.risk) || '';
        if (r === 'High' && !allowHigh) return false;
        if (r === 'Medium' && !allowMed) return false;
        if (r === 'Low' && !allowLow) return false;
        return true;
      });
      
      if (term) {
        result = result.filter(o => {
          const text = [o.location, o.inspector, o.responsible, o.observation, o.actionTaken, o.risk]
            .filter(Boolean)
            .join(' ')
            .toLowerCase();
          return text.includes(term);
        });
      }
      
      if (range && range !== 'all') {
        const now = new Date();
        let from = null;

        switch (range) {
          case 'today':
            from = new Date(now.setHours(0, 0, 0, 0));
            break;
          case 'week':
            from = new Date(now.setDate(now.getDate() - now.getDay()));
            from.setHours(0, 0, 0, 0);
            break;
          case 'month':
            from = new Date(now.getFullYear(), now.getMonth(), 1);
            break;
        }

        if (from) {
          result = result.filter(o => {
            const dStr = o.date || o.formattedDate || o.timestamp;
            const d = dStr ? new Date(dStr) : null;
            return d && d >= from;
          });
        }
      }
      
      window.filteredObservations = result;
      renderObservations(result);
    }
    
    // Helper function to render observation cards
    function renderObservations(observations) {
      const observationsList = document.getElementById('observationsList');
      observationsList.innerHTML = '';

      if (!observations || observations.length === 0) {
        renderNoObservations();
        return;
      }

      observations.forEach(obs => {
        const riskLevel = obs.risk_level || 'N/A';
        let riskClass = '';
        let riskBg = '';
        switch (riskLevel.toLowerCase()) {
          case 'high': riskClass = 'text-danger'; riskBg = 'bg-danger-soft'; break;
          case 'medium': riskClass = 'text-warning'; riskBg = 'bg-warning-soft'; break;
          case 'low': riskClass = 'text-success'; riskBg = 'bg-success-soft'; break;
        }

        const card = document.createElement('div');
        card.className = 'col-12 col-md-6 col-lg-4';
        const photoUrl = (obs.photos && obs.photos.length > 0) ? obs.photos[0] : null;

        card.innerHTML = `
          <div class="card h-100 shadow-sm observation-card ${riskBg}">
            ${photoUrl ? `<img src="${photoUrl}" class="card-img-top" alt="Observation Photo" data-full-src="${photoUrl}">` : ''}
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <span class="badge bg-light ${riskClass} border">${riskLevel}</span>
                <span class="text-muted small">${obs.created_at ? new Date(obs.created_at).toLocaleDateString() : 'N/A'}</span>
              </div>
              <h6 class="card-title mb-1">${obs.location || 'N/A'}</h6>
              <p class="text-muted small mb-2">Inspector: ${obs.inspector || 'N/A'}</p>
              <div class="observation-content">
                <p class="card-text small">${obs.observation || ''}</p>
              </div>
              <div class="mt-3">
                <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteObservation('${obs.id}')">Delete</button>
              </div>
            </div>
          </div>
        `;
        observationsList.appendChild(card);
      });

      // Update statistics for the rendered list
      updateStatistics(observations);
    }
    
    // Update statistics counters safely
    function updateStatistics(list) {
      try {
        const data = Array.isArray(list)
          ? list
          : (Array.isArray(window.filteredObservations) && window.filteredObservations.length
             ? window.filteredObservations
             : (Array.isArray(window.allObservations) ? window.allObservations : []));
        const totalEl = document.getElementById('totalObservations');
        if (totalEl) totalEl.textContent = data.length;
        const counts = { High: 0, Medium: 0, Low: 0 };
        data.forEach(o => {
          const r = (o && o.risk) || '';
          if (r === 'High') counts.High++;
          else if (r === 'Medium') counts.Medium++;
          else if (r === 'Low') counts.Low++;
        });
        const highEl = document.getElementById('highRiskCount');
        const medEl = document.getElementById('mediumRiskCount');
        const lowEl = document.getElementById('lowRiskCount');
        if (highEl) highEl.textContent = counts.High;
        if (medEl) medEl.textContent = counts.Medium;
        if (lowEl) lowEl.textContent = counts.Low;
      } catch (e) {
        console.error('updateStatistics failed:', e);
      }
    }
    
    // Render no observations message
    function renderNoObservations() {
      const observationsList = document.getElementById('observationsList');
      observationsList.innerHTML = `
        <div class="col-12 text-center py-5">
          <div class="card shadow-sm border-0" style="background: transparent;">
            <div class="card-body">
              <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
              <h5 class="mt-3 mb-1">No observations found</h5>
              <p class="text-muted mb-0">Try adjusting your filters or add a new observation.</p>
            </div>
          </div>
        </div>`;
      // keep stats consistent
      updateStatistics([]);
    }
    
    // Delete observation from localStorage
    async function deleteObservation(docId) {
      if (!confirm('Are you sure you want to delete this observation? This action cannot be undone.')) {
        return;
      }

      try {
        const { error } = await supabase
          .from('observations')
          .delete()
        const dateEl = document.getElementById('dateRangeFilter');
        
        let allowHigh = highEl ? highEl.checked : true;
        let allowMed = medEl ? medEl.checked : true;
        let allowLow = lowEl ? lowEl.checked : true;
        // If none selected, show all by default
        if (highEl || medEl || lowEl) {
          const noneSelected = !allowHigh && !allowMed && !allowLow;
          if (noneSelected) {
            allowHigh = allowMed = allowLow = true;
          }
        }
        const range = dateEl ? dateEl.value : 'all';
        
        const source = Array.isArray(window.allObservations) ? window.allObservations : [];
        let result = source.filter(o => {
          const r = (o && o.risk) || '';
          if (r === 'High' && !allowHigh) return false;
          if (r === 'Medium' && !allowMed) return false;
          if (r === 'Low' && !allowLow) return false;
          return true;
        });
        
        if (term) {
          result = result.filter(o => {
            const text = [o.location, o.inspector, o.responsible, o.observation, o.actionTaken, o.risk]
              .filter(Boolean)
              .join(' ')
              .toLowerCase();
            return text.includes(term);
          });
        }
        
        if (range && range !== 'all') {
          const now = new Date();
          let from = null;

          switch (range) {
            case 'today':
              from = new Date(now.setHours(0, 0, 0, 0));
              break;
            case 'week':
              from = new Date(now.setDate(now.getDate() - now.getDay()));
              from.setHours(0, 0, 0, 0);
              break;
            case 'month':
              from = new Date(now.getFullYear(), now.getMonth(), 1);
              break;
          }

          if (from) {
            result = result.filter(o => {
              const dStr = o.date || o.formattedDate || o.timestamp;
              const d = dStr ? new Date(dStr) : null;
              return d && d >= from;
            });
          }
        }
        
        window.filteredObservations = result;
        console.log('applyFilters -> rendering', result.length, 'observations');
        renderObservations(result);
      } catch (e) {
        console.error('applyFilters failed:', e);
        renderObservations([]);
      }
    }

    // Show notification to user with enhanced styling and icons
    function showNotification(message, type = 'info', title = null) {
      // Map notification types to icons
      const icons = {
        success: 'check-circle-fill',
        danger: 'exclamation-triangle-fill',
        warning: 'exclamation-triangle-fill',
        info: 'info-circle-fill'
      };
      
      // Set default title based on type if not provided
      if (!title) {
        title = type.charAt(0).toUpperCase() + type.slice(1);
      }
      
      const toast = document.createElement('div');
      toast.className = `toast notification-${type} rounded-3 shadow-sm`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      
      // Add animation class
      toast.style.transition = 'all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55)';
      toast.style.transform = 'translateX(120%)';
      
      // Set icon color based on type
      const iconColor = type === 'warning' ? '#000' : '#fff';
      
      toast.innerHTML = `
        <div class="toast-header bg-${type} text-white border-0 rounded-top-3">
          <i class="bi bi-${icons[type] || 'info-circle-fill'} me-2"></i>
          <strong class="me-auto">${title}</strong>
          <small class="text-white-50">just now</small>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body bg-white text-dark rounded-bottom-3">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              ${message}
            </div>
          </div>
        </div>
        <div class="progress" style="height: 3px;">
          <div class="progress-bar bg-${type} progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
      `;
      
      const toastContainer = document.querySelector('.toast-container') || createToastContainer();
      toastContainer.appendChild(toast);
      
      // Force reflow to enable animation
      void toast.offsetWidth;
      
      // Show toast with animation
      setTimeout(() => {
        toast.style.transform = 'translateX(0)';
      }, 10);
      
      const bsToast = new bootstrap.Toast(toast, { 
        autohide: true, 
        delay: 5000,
        animation: false // We handle animation manually
      });
      
      bsToast.show();
      
      // Add progress bar animation
      const progressBar = toast.querySelector('.progress-bar');
      if (progressBar) {
        progressBar.style.transition = 'width 5s linear';
        setTimeout(() => {
          progressBar.style.width = '0%';
        }, 100);
      }
      
      // Remove the toast after it's hidden
      toast.addEventListener('hidden.bs.toast', () => {
        toast.style.transform = 'translateX(120%)';
        setTimeout(() => {
          toast.remove();
        }, 400);
      });
    }
    
    function createToastContainer() {
      const container = document.createElement('div');
      container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
      container.style.zIndex = '1100';
      container.style.maxWidth = '350px';
      container.style.width = '100%';
      document.body.appendChild(container);
      return container;
    }
    
    // Load observations from Supabase and update UI state
    async function loadObservationsFromSupabase() {
      try {
        const { data, error } = await supabase
          .from('observations')
          .select('id, location, observation, risk_level, action_taken, responsible, photos, created_at, assessors(name)')
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Error loading observations:', error);
          renderNoObservations();
          return;
        }

        // Filter out duplicate observations based on the 'observation' text
        const uniqueObservations = data.filter((obs, index, self) =>
          index === self.findIndex(o => o.observation === obs.observation)
        );

        window.allObservations = uniqueObservations.map(obs => ({
          id: obs.id,
          location: obs.location,
          observation: obs.observation,
          risk: obs.risk_level,
          actionTaken: obs.action_taken,
          photos: (obs.photos || []).map(p => (typeof p === 'string' ? p : p.url)).filter(Boolean),
          responsible: obs.responsible,
          inspector: obs.assessors ? obs.assessors.name : 'Unknown',
          date: obs.created_at,
        }));
        
      } catch (e) {
        console.error('Failed to load observations from Supabase:', e);
        window.allObservations = [];
        renderNoObservations();
      }
    }

    // Manual refresh helper for debugging or UI hooks
    async function refreshObservations() {
      await loadObservationsFromSupabase();
      applyFilters();
      console.log('refreshObservations -> done');
    }


    // Update inspector dropdown with the current assessor's name
    function updateInspectorDropdown(assessorName) {
      const inspectorSelect = document.getElementById('inspector');
      if (inspectorSelect) {
        // Clear existing options except the first one
        while (inspectorSelect.options.length > 1) {
          inspectorSelect.remove(1);
        }
        
        // Add the assessor's name as an option and select it
        const option = new Option(assessorName, assessorName, false, true);
        inspectorSelect.add(option);
      }
    }
    
    // Check for assessor profile (local)
    async function checkAssessorProfile(uid) {
      try {
        const saved = JSON.parse(localStorage.getItem('assessorData') || 'null');
        if (saved) {
          currentUser = saved;
          updateUserProfile(currentUser);
          enableAllTabs();
        }
      } catch (_) {}
    }
    
    // Toggle between login and signup forms
    function toggleAuthForms() {
      const loginForm = document.getElementById('loginForm');
      const signupForm = document.getElementById('signupForm');
      
      if (loginForm.style.display === 'none') {
        loginForm.style.display = 'block';
        signupForm.style.display = 'none';
      } else {
        loginForm.style.display = 'none';
        signupForm.style.display = 'block';
      }
    }

    // Initialize the application when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Setup form submission with file handling
      const hseForm = document.getElementById('hseForm');
      if (hseForm) {
        hseForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          // Get form values
          const location = document.getElementById('location')?.value || '';
          const date = document.getElementById('date')?.value || '';
          const risk = document.getElementById('risk')?.value || '';
          const responsible = document.getElementById('responsible')?.value || '';
          const inspector = document.getElementById('inspector')?.value || '';
          const observation = document.getElementById('observation')?.value || '';
          const actionTaken = document.getElementById('actionTaken')?.value || '';
          
          // Handle file uploads
          const fileInput = document.getElementById('photo');
          let photoUrls = [];
          
          if (fileInput && fileInput.files && fileInput.files.length > 0) {
            try {
              // Process each file
              const files = Array.from(fileInput.files);
              photoUrls = await processPhotos(files);
            } catch (error) {
              console.error('Error processing photos:', error);
              showNotification('Error uploading photos. Please try again.', 'error');
              return;
            }
          }
          
          // Create observation object
          const observationData = {
            location,
            date,
            risk,
            responsible,
            inspector,
            observation,
            actionTaken,
            photos: photoUrls,
            createdAt: new Date().toISOString(),
            createdBy: (currentUser && (currentUser.id || currentUser.email)) || 'local'
          };
          
          // Save to Supabase
          try {
            const payload = {
              assessor_id: currentUser?.assessor_id || null,
              location,
              observation,
              risk_level: risk,
              action_taken: actionTaken,
              responsible,
              photos: photoUrls,
            };
            const { data, error } = await supabase
              .from('observations')
              .insert(payload)
              .select('id')
              .single();
            if (error) throw error;

            showNotification('Inspection report submitted successfully!', 'success');
            hseForm.reset();
            const photoPreview = document.getElementById('photoPreview');
            if (photoPreview) photoPreview.innerHTML = '';
            await loadObservationsFromSupabase();
            applyFilters();
          } catch (error) {
            console.error('Error saving report:', error);
            showNotification('Failed to save report: ' + error.message, 'danger');
          }
        });
      }
      
      // Setup photo preview
      const photoInput = document.getElementById('photo');
      if (photoInput) {
        photoInput.addEventListener('change', function() {
          const preview = document.getElementById('photoPreview');
          if (!preview) return;
          
          preview.innerHTML = ''; // Clear previous previews
          
          if (this.files && this.files.length > 0) {
            Array.from(this.files).forEach(file => {
              if (!file.type.startsWith('image/')) return;
              
              const reader = new FileReader();
              reader.onload = function(e) {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'img-preview-container me-2 mb-2 d-inline-block';
                
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'img-preview';
                img.style.maxWidth = '100px';
                img.style.maxHeight = '100px';
                
                imgContainer.appendChild(img);
                preview.appendChild(imgContainer);
              };
              reader.readAsDataURL(file);
            });
          }
        });
      }
      
      // No local session restore; rely on Supabase-backed state only
      
      // Initialize date field with current date
      const dateField = document.getElementById('date');
      if (dateField) {
        dateField.value = new Date().toISOString().split('T')[0];
      }
      
      // Initialize Firebase Auth state observer and forms
      initAuth();
      setupAuthForms();
      
      // Add event listener for save assessor button
      document.getElementById('saveAssessorBtn').addEventListener('click', async () => {
        // Show loading state
        const btn = document.getElementById('saveAssessorBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Saving...';
        
        await saveAssessorInfo();
        
        // Reset button state
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Save & Continue';
      });
      
      // Initialize other components...
    });
    
    // Backend removed: no Firebase Auth state listener
    // If assessor data exists locally, UI is handled on load above.
  </script>
  <style>
    /* Material Glass Theme */
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      min-height: 100vh;
      margin: 0;
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      color: var(--text-main);
      line-height: 1.6;
    }
    
    /* Main Container */
    .main-container {
      display: flex;
      min-height: 100vh;
      padding: 1.5rem;
      gap: 1.5rem;
    }
    
    /* Glass Card Container */
    .glass-card {
      flex: 1;
      display: flex;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 24px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      overflow: hidden;
    }
    
    /* Table with Glass Effect */
    .table {
      --bs-table-bg: transparent;
      --bs-table-striped-bg: rgba(0, 0, 0, 0.02);
      --bs-table-hover-bg: rgba(0, 0, 0, 0.05);
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .table > :not(caption) > * > * {
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 1rem 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .table > thead > tr > th {
      background: rgba(255, 255, 255, 0.6);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      border-bottom: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .table-hover > tbody > tr:hover > * {
      --bs-table-accent-bg: rgba(255, 255, 255, 0.7);
    }
    
    .table-striped > tbody > tr:nth-of-type(odd) > * {
      --bs-table-accent-bg: rgba(0, 0, 0, 0.02);
    }
    
    .table-responsive {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }
    
    /* Tab Content */
    .tab-content {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 0 20px 20px 0;
    }
    
    :root {
      /* Glass effect variables */
      --glass-bg: rgba(255, 255, 255, 0.7);
      --glass-border: rgba(255, 255, 255, 0.18);
      --glass-blur: blur(12px);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      
      /* Theme colors */
      --primary-color: #3f51b5;
      --primary-light: #757de8;
      --primary-dark: #002984;
      --secondary-color: #ff4081;
      --success-color: #4caf50;
      --danger-color: #f44336;
      --warning-color: #ff9800;
      --info-color: #2196f3;
      
      /* Text colors */
      --text-main: rgba(0, 0, 0, 0.87);
      --text-secondary: rgba(0, 0, 0, 0.6);
      --text-hint: rgba(0, 0, 0, 0.38);
      --text-on-primary: #ffffff;
      
      /* Background colors */
      --bg-main: #f5f5f7;
      --bg-card: var(--glass-bg);
      --bg-menu: rgba(255, 255, 255, 0.5);
      --bg-hover: rgba(0, 0, 0, 0.04);
      --bg-active: rgba(0, 0, 0, 0.08);
      
      /* Shadows */
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.1);
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      
      /* Border radius */
      --radius-sm: 4px;
      --radius: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
      
      /* Transitions */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Material Glass Theme */
    :root {
      /* Glass effect variables */
      --glass-bg: rgba(255, 255, 255, 0.25);
      --glass-border: rgba(255, 255, 255, 0.18);
      --glass-blur: blur(12px);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      
      /* Theme colors */
      --primary-color: #3f51b5;
      --primary-light: #757de8;
      --primary-dark: #002984;
      --secondary-color: #ff4081;
      --success-color: #4caf50;
      --danger-color: #f44336;
      --warning-color: #ff9800;
      --info-color: #2196f3;
      
      /* Text colors */
      --text-primary: rgba(0, 0, 0, 0.87);
      --text-secondary: rgba(0, 0, 0, 0.6);
      --text-hint: rgba(0, 0, 0, 0.38);
      --text-on-primary: #ffffff;
      --text-on-secondary: #000000;
      
      /* Background colors */
      --bg-primary: #f5f5f7;
      --bg-secondary: #ffffff;
      --bg-surface: rgba(255, 255, 255, 0.7);
      --bg-hover: rgba(0, 0, 0, 0.04);
      --bg-active: rgba(0, 0, 0, 0.08);
      
      /* Shadows */
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.1);
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      
      /* Border radius */
      --radius-sm: 4px;
      --radius: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
      
      /* Transitions */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
      
      /* Spacing */
      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-10: 2.5rem;
      --space-12: 3rem;
      --space-16: 4rem;
      --space-20: 5rem;
      --space-24: 6rem;
      --space-32: 8rem;
      --space-40: 10rem;
      --space-48: 12rem;
      --space-56: 14rem;
      --space-64: 16rem;
    }

    /* Dark theme variables */
    [data-theme="dark"] {
      --bg-main: #121212;
      --bg-card: rgba(30, 30, 30, 0.9);
      --bg-menu: rgba(40, 40, 40, 0.8);
      --text-main: #f0f0f0;
      --text-link: #64b5f6;
      --text-link-hover: #90caf9;
      --shadow-main: 0 4px 24px rgba(0, 0, 0, 0.3);
    }

    body {
      background: linear-gradient(135deg, #e0e7ff 0%, #d1e0fd 100%);
      min-height: 100vh;
      font-family: 'Roboto', sans-serif;
      color: var(--text-main);
      -webkit-backdrop-filter: blur(16px);
      backdrop-filter: blur(16px);
      display: flex;
      flex-direction: column;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Smooth Transitions and Hover Effects */
    * {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      scroll-behavior: smooth;
    }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
      transition: background 0.3s ease;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.2);
    }
    
    /* Subtle Hover Effects */
    .nav-link, .dropdown-item {
      position: relative;
      overflow: hidden;
    }
    
    .nav-link::after, .dropdown-item::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 2px;
      background: var(--primary-color);
      transition: width 0.3s ease;
    }
    
    .nav-link:hover::after, .dropdown-item:hover::after {
      width: 100%;
    }
    
    /* Focus States */
    a:focus, button:focus, input:focus, select:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.25) !important;
    }
    
    /* Loading Animation */
    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }
    
    .loading {
      animation: pulse 1.5s infinite ease-in-out;
    }

    /* Main Layout */
    .main-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .glass-card {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 1.5rem;
      width: calc(100% - 2rem);
      max-width: 1620px;
      margin: 1rem auto;
      box-shadow: var(--shadow-main);
      backdrop-filter: blur(10px);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      animation: fadeIn 1s ease-in-out;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow-x: hidden;
    }

    .glass-card:hover {
      transform: scale(1.01);
      box-shadow: 0 12px 36px rgba(0, 0, 0, 0.25);
    }

    /* Typography */
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
    }
    
    h2 {
      position: relative;
      padding-bottom: 10px;
      margin-bottom: 25px;
    }
    
    h2:after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      height: 3px;
      width: 60px;
      background: var(--primary-color);
      border-radius: 3px;
    }
    
    .card-title {
      font-weight: 600;
    }

    /* Side Menu with Frosted Glass Effect */
    .side-menu {
      position: relative;
      left: 0;
      top: 0;
      height: 100%;
      min-width: 260px;
      max-width: 280px;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-right: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 2px 0 16px rgba(0, 0, 0, 0.05);
      z-index: 1040;
      padding: 1.5rem 0.75rem;
      transition: all 0.3s ease;
      overflow-y: auto;
    }

    .menu-heading {
      color: var(--primary-color);
      font-weight: 700;
      font-size: 1.25rem;
      letter-spacing: 2px;
      text-align: center;
      margin-bottom: 1.5rem;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .nav-link {
      color: var(--text-main) !important;
      transition: all 0.3s ease;
      margin-bottom: 8px;
      border-radius: 8px;
      text-align: left;
      font-family: 'Montserrat', sans-serif;
      font-weight: 500;
      padding: 0.75rem 1rem;
    }

    .nav-link.active, .nav-link:focus {
      background: var(--primary-color);
      color: white !important;
      box-shadow: 0 4px 12px rgba(6, 50, 94, 0.3);
    }

    .nav-link:hover {
      background: rgba(6, 50, 94, 0.1);
      transform: scale(1.05);
    }

    /* Content Area */
    .tab-content {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
      min-height: 0;
      width: 100%;
    }

    /* Form controls with Glass Effect */
    .form-control, .form-select, .form-range, .form-check-input {
      border-radius: 12px;
      padding: 0.75rem 1rem;
      background: rgba(255, 255, 255, 0.7) !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--text-main);
    }
    
    .form-control:focus, .form-select:focus, .form-range:focus, .form-check-input:focus {
      background: rgba(255, 255, 255, 0.9) !important;
      border-color: var(--primary-color) !important;
      box-shadow: 0 0 0 0.25rem rgba(63, 81, 181, 0.15) !important;
      outline: none;
    }
    
    /* Form Labels */
    .form-label, .form-check-label {
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
      display: block;
    }
    
    /* Form Groups */
    .form-group {
      margin-bottom: 1.5rem;
      position: relative;
    }
    
    /* Form Icons */
    .input-group-text {
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--text-secondary);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    
    /* Custom Checkbox and Radio */
    .form-check-input {
      width: 1.2em;
      height: 1.2em;
      margin-top: 0.2em;
      vertical-align: top;
      background-color: rgba(255, 255, 255, 0.7);
      background-repeat: no-repeat;
      background-position: center;
      background-size: contain;
      border: 1px solid rgba(0, 0, 0, 0.1);
      appearance: none;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    
    .form-check-input:checked {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    /* Range Input */
    .form-range::-webkit-slider-thumb {
      background: var(--primary-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .form-range::-moz-range-thumb {
      background: var(--primary-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .form-range::-webkit-slider-runnable-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 1rem;
    }
    
    .form-range::-moz-range-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 1rem;
    }

    /* Modal with Glass Effect */
    .modal-content {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .modal-header {
      background: rgba(255, 255, 255, 0.4);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    
    .modal-body {
      background: rgba(255, 255, 255, 0.6);
    }
    
    .modal-footer {
      background: rgba(255, 255, 255, 0.4);
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    
    /* Tooltips */
    .tooltip {
      --bs-tooltip-bg: rgba(63, 81, 181, 0.9);
      --bs-tooltip-padding-x: 0.75rem;
      --bs-tooltip-padding-y: 0.5rem;
      --bs-tooltip-border-radius: 8px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    
    .tooltip-inner {
      background: var(--bs-tooltip-bg);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    
    /* Buttons with Glass Effect */
    .btn {
      border-radius: 12px;
      padding: 0.75rem 1.5rem;
      font-weight: 500;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      font-size: 0.875rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }
    
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      border: none;
      color: white;
    }
    
    .btn-outline-primary {
      background: rgba(255, 255, 255, 0.3);
      color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    .btn-outline-primary:hover {
      background: rgba(63, 81, 181, 0.1);
      color: var(--primary-dark);
      border-color: var(--primary-dark);
    }

    /* Observation Cards */
    .observation-card {
      opacity: 0;
      transform: translateY(30px);
      animation: observationFadeIn 0.7s cubic-bezier(0.23, 1, 0.32, 1) forwards;
      margin-bottom: 1.5rem;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
      border: none;
    }

    .card {
      margin-bottom: 1.5rem;
      background: rgba(255, 255, 255, 0.6) !important;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      border-radius: 16px !important;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateY(0);
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      border-color: rgba(255, 255, 255, 0.3) !important;
    }
    
    .card-header {
      background: rgba(255, 255, 255, 0.4) !important;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2) !important;
      padding: 1rem 1.5rem;
      font-weight: 600;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    
    .card-body {
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.4);
    }
    
    .card-footer {
      background: rgba(255, 255, 255, 0.3);
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      padding: 1rem 1.5rem;
    }

    .observation-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    
    .badge {
      font-weight: 500;
      padding: 0.5em 0.8em;
      border-radius: 8px;
      font-family: 'Montserrat', sans-serif;
    }

    /* Google Sheets Embed */
    .sheet-container {
      position: relative;
      width: 100%;
      height: 0;
      padding-bottom: 75%;
      overflow: hidden;
      border-radius: 12px;
      background: rgba(255,255,255,0.1);
      margin: 1rem 0;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.05);
    }

    .sheet-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }
    
    /* Equipment Tabs */
    .equipment-tabs-container {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 6px 18px rgba(0,0,0,0.05);
      margin-top: 1rem;
    }
    
    /* Enhanced Tabs with Glass Effect */
    .nav-tabs {
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      margin-bottom: 1.5rem;
      padding: 0.5rem 0.5rem 0;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 16px 16px 0 0;
    }

    .nav-tabs .nav-link {
      border: none;
      border-radius: 12px 12px 0 0;
      margin: 0 0.25rem;
      padding: 0.8rem 1.5rem;
      color: var(--text-secondary);
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      background: transparent;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }

    .nav-tabs .nav-link:hover {
      background: rgba(255, 255, 255, 0.4);
      color: var(--primary-color);
      transform: translateY(-2px);
    }

    .nav-tabs .nav-link.active {
      background: rgba(255, 255, 255, 0.6);
      color: var(--primary-color);
      font-weight: 600;
      border: none;
      position: relative;
    }
    
    .nav-tabs .nav-link.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
      border-radius: 3px 3px 0 0;
    }
    
    .nav-tabs .nav-link:hover:not(.active) {
      background: rgba(6, 50, 94, 0.1);
    }
    
    .tab-pane h3 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      color: var(--primary-color);
    }

    /* About Me Section */
    .profile-img {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border: 3px solid var(--primary-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #1976d2;
      margin: 0 auto 1.5rem;
    }
    
    .social-links {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      margin-top: 1.5rem;
    }
    
    .social-links .btn {
      margin: 0;
      min-width: 140px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .list-group-item {
      background: transparent;
      border: none;
      padding: 0.75rem 1.25rem;
      font-family: 'Roboto', sans-serif;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes observationFadeIn {
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes tabPop {
      0% { transform: scale(0.8); }
      60% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* Responsive Adjustments */
    @media (max-width: 992px) {
      .side-menu {
        min-width: 200px;
      }
      
      .glass-card {
        padding: 1.25rem;
      }
    }

    @media (max-width: 768px) {
      .d-flex.flex-row {
        flex-direction: column;
      }
      
      .side-menu {
        max-width: 100%;
        height: auto;
        max-height: 200px;
        border-radius: 20px 20px 0 0;
        margin-bottom: 1rem;
      }
      
      .tab-content {
        padding: 1rem;
      }
      
      .social-links {
        flex-direction: column;
        align-items: center;
      }
    }

    @media (max-width: 576px) {
      .glass-card {
        padding: 1rem;
        margin: 0.75rem auto;
        width: calc(100% - 1.5rem);
      }
      
      .profile-img {
        width: 120px;
        height: 120px;
      }
      
      .social-links .btn {
        width: 100%;
      }
      
      .nav-tabs .nav-link {
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
      }
    }
    
    /* Animated Theme Toggle */
    :root {
      --sz: 2.5vmin;  /* size */
      --on: #269fe5;  /* color on */
      --of: #616774;  /* color off */
      --tr: all 0.25s ease 0s;
    }
    
    .theme-toggle-container {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      width: calc(var(--sz) * 4);
    }
    
    .toggle-wrapper {
      position: relative;
      width: 60px;
      height: 32px;
      perspective: 1000px;
    }
    
    .toggle-input {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-label {
      position: relative;
      display: block;
      width: 100%;
      height: 100%;
      cursor: pointer;
      user-select: none;
    }
    
    .toggle-track {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(145deg, #e6e6e6, #ffffff);
      border-radius: 20px;
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }
    
    [data-theme="dark"] .toggle-track {
      background: linear-gradient(145deg, #2d3748, #1a202c);
      box-shadow: inset 0 2px 15px rgba(0, 0, 0, 0.4);
    }
    
    .toggle-thumb {
      position: absolute;
      top: 4px;
      left: 4px;
      width: 24px;
      height: 24px;
      background: linear-gradient(145deg, #f6d365, #fda085);
      border-radius: 50%;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .toggle-input:checked + .toggle-label .toggle-thumb {
      transform: translateX(28px);
      background: linear-gradient(145deg, #a78bfa, #8b5cf6);
    }
    
    .toggle-icons {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .sun-icon, .moon-icon {
      position: absolute;
      transition: all 0.3s ease;
      font-size: 12px;
      color: #f8f9fa;
    }
    
    .sun-icon {
      opacity: 1;
      transform: scale(1) rotate(0deg);
    }
    
    .moon-icon {
      opacity: 0;
      transform: scale(0) rotate(90deg);
    }
    
    .toggle-input:checked + .toggle-label .sun-icon {
      opacity: 0;
      transform: scale(0) rotate(-90deg);
    }
    
    .toggle-input:checked + .toggle-label .moon-icon {
      opacity: 1;
      transform: scale(1) rotate(0deg);
    }
    
    .toggle-ripple {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 1px;
      height: 1px;
      background: rgba(59, 130, 246, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%) scale(0);
      transition: transform 0.6s ease-out, opacity 0.6s ease-out;
      pointer-events: none;
      opacity: 0;
    }
    
    .toggle-input:active + .toggle-label .toggle-ripple {
      transform: translate(-50%, -50%) scale(40);
      opacity: 1;
      transition: transform 0.6s ease-out, opacity 0.6s ease-out;
    }
    
    .toggle-input:focus-visible + .toggle-label .toggle-track {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
    }
    
    input[type="checkbox"] {
      display: none;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .theme-toggle-container {
        --sz: 3vmin;
        bottom: 1.5rem;
        right: 1.5rem;
      }
    }
    
    /* Original theme toggle styles (hidden) */
    .theme-toggle {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      border: none;
      box-shadow: var(--shadow-main);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      z-index: 1000;
      transition: all 0.3s ease;
    }

    .theme-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .theme-toggle i {
      transition: transform 0.3s ease;
    }

    [data-theme="dark"] .glass-card,
    [data-theme="dark"] .glass-link {
      background: var(--bg-card);
      color: var(--text-main);
    }

    [data-theme="dark"] .card,
    [data-theme="dark"] .form-control,
    [data-theme="dark"] .form-select {
      background-color: var(--bg-card);
      color: var(--text-main);
      border-color: #444;
    }

    [data-theme="dark"] .form-control:focus,
    [data-theme="dark"] .form-select:focus {
      background-color: var(--bg-card);
      color: var(--text-main);
      border-color: var(--primary-color);
    }
    
    [data-theme="dark"] body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    }
    
    [data-theme="dark"] h2:after {
      background: var(--text-link);
    }
    
    /* Plant & Equipment custom styling */
    .plant-equipment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .equipment-description {
      background: rgba(6, 50, 94, 0.08);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }
    
    .equipment-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem 1rem;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
      border: 1px solid #e9ecef;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    
    .stat-icon {
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 1.5rem;
      opacity: 0.2;
    }
    
    .stat-value {
      font-size: 2.25rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      line-height: 1.2;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: var(--text-main);
      opacity: 0.8;
    }
    
    .equipment-section {
      margin-bottom: 2rem;
    }
    
    .equipment-section h3 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    
    [data-theme="dark"] .equipment-section h3 {
      border-bottom: 1px solid rgba(6, 50, 94, 0.1);
    }
    
    .equipment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    
    .equipment-item {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 1.25rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: transform 0.3s ease;
    }
    
    .equipment-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    
    .equipment-icon {
      font-size: 2.5rem;
      color: var(--primary-color);
      margin-bottom: 1rem;
    }
    
    .equipment-info {
      margin-top: 0.5rem;
    }
    
    /* Notification Styles */
    .toast-container {
      z-index: 1100;
      position: fixed;
      bottom: 20px;
      right: 20px;
      max-width: 350px;
      width: 100%;
    }
    
    .toast {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      margin-bottom: 15px;
      border: none;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      transform: translateX(120%);
      opacity: 1;
      border-left: 4px solid transparent;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.hide {
      transform: translateX(120%);
    }
    
    .toast-header {
      border: none;
      padding: 12px 15px;
      font-weight: 600;
      background-color: rgba(255,255,255,0.1);
    }
    
    .toast-body {
      padding: 15px;
      font-size: 0.95rem;
    }
    
    /* Notification Types */
    .toast.bg-success {
      background-color: #198754 !important;
      border-left-color: #0f5132;
    }
    
    .toast.bg-danger {
      background-color: #dc3545 !important;
      border-left-color: #842029;
    }
    
    .toast.bg-warning {
      background-color: #ffc107 !important;
      color: #000;
      border-left-color: #997404;
    }
    
    .toast.bg-info {
      background-color: #0dcaf0 !important;
      border-left-color: #087990;
    }
    
    /* Progress bar animation */
    .progress {
      height: 3px;
      background: rgba(0,0,0,0.1);
      border-radius: 0;
    }
    
    .progress-bar {
      transition: width 5s linear;
    }
    
    /* Authentication Styles */
    .auth-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      text-align: center;
    }
    
    .auth-card {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: var(--shadow-main);
      backdrop-filter: blur(10px);
      max-width: 400px;
      width: 100%;
    }
    
    .embedded-content {
      width: 100%;
      height: 600px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      margin: 20px 0;
    }
    
    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0.5rem 1rem;
      background: var(--bg-card);
      border-radius: 25px;
      margin-bottom: 1rem;
    }
    
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      margin-left: auto;
    }
    
    .tab-disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 0.25rem 0;
      border-bottom: 1px dashed rgba(0,0,0,0.1);
    }
    
    [data-theme="dark"] .info-item {
      border-bottom: 1px dashed rgba(6, 50, 94, 0.1);
    }
    
    .info-label {
      font-weight: 500;
    }
    
    .info-value {
      font-weight: 500;
      color: var(--primary-color);
    }
    
    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      margin-top: 0.5rem;
      display: inline-block;
    }
    
    .status-active {
      background: rgba(40, 167, 69, 0.15);
      color: #28a745;
    }
    
    .status-inactive {
      background: rgba(220, 53, 69, 0.15);
      color: #dc3545;
    }
    
    .status-maintenance {
      background: rgba(255, 193, 7, 0.15);
      color: #ffc107;
    }
    
    /* Profile icon styling */
    .profile-icon {
      font-size: 4rem;
      color: white;
    }
    
    /* Image preview styles */
    .img-preview-container {
      position: relative;
      width: 100px;
      height: 100px;
      margin: 0 10px 10px 0;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: all 0.2s ease-in-out;
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      display: inline-block;
    }
    
    .img-preview-container:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .img-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    
    .file-preview {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      padding: 10px;
      background: #f8f9fa;
    }
    
    /* Image modal styles */
    #imageModal .modal-content {
      background-color: #f8f9fa;
      border: none;
      box-shadow: 0 5px 30px rgba(0,0,0,0.2);
    }
    
    #imageModal .modal-header {
      border-bottom: 1px solid #e9ecef;
      background-color: #fff;
    }
    
    #imageModal .modal-footer {
      border-top: 1px solid #e9ecef;
      background-color: #fff;
    }
    
    #modalImage {
      max-height: 70vh;
      max-width: 100%;
      margin: 0 auto;
      display: block;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    /* Dark theme adjustments for image previews */
    [data-theme="dark"] .img-preview-container {
      background-color: #2d2d2d;
      border-color: #444;
    }
    
    [data-theme="dark"] .file-preview {
      background-color: #2d2d2d;
      color: #f0f0f0;
    }
    
    [data-theme="dark"] #imageModal .modal-content {
      background-color: #1e1e1e;
      color: #f0f0f0;
    }
    
    [data-theme="dark"] #imageModal .modal-header,
    [data-theme="dark"] #imageModal .modal-footer {
      background-color: #252525;
      border-color: #444;
    }
    
    /* Stats counters */
    .stats-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-item {
      flex: 1;
      min-width: 200px;
      background: var(--bg-card);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    
    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color);
      margin: 5px 0;
    }
    
    .stat-title {
      font-size: 0.9rem;
      color: var(--text-main);
      opacity: 0.8;
    }
    
    /* Sign Out Button Styles */
    .sign-out-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      padding: 0;
      background: rgba(220, 53, 69, 0.1);
      color: #dc3545;
      border: 1px solid rgba(220, 53, 69, 0.2);
      border-radius: 50%;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .sign-out-btn:hover {
      background: rgba(220, 53, 69, 0.15);
      border-color: rgba(220, 53, 69, 0.4);
      transform: translateY(-1px) scale(1.05);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    
    .sign-out-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .sign-out-btn i {
      transition: transform 0.2s ease;
      font-size: 0.9rem;
    }
    
    .sign-out-btn:hover i {
      transform: scale(1.1);
    }
    
    /* Login form */
    .login-container {
      max-width: 500px;
      margin: 0 auto;
      padding: 30px;
      background: var(--bg-card);
      border-radius: 15px;
      box-shadow: var(--shadow-main);
    }
    
    .chart-container {
      height: 300px;
      margin: 30px 0;
    }
    
    .chart-wrapper {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body data-theme="light">
  <!-- Auth Screen (disabled) -->
  <div id="authPage" style="display:none; width:100%; background: linear-gradient(135deg, rgba(25,118,210,0.08), rgba(156,39,176,0.08));">
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
          <div class="login-container shadow-sm border-0 rounded-3 bg-white p-4">
            <h3 class="mb-3 text-center"><i class="bi bi-shield-lock me-2"></i>Sign In</h3>
            <form id="signInForm">
              <div class="mb-3">
                <label for="loginEmail" class="form-label">Email</label>
                <input type="email" class="form-control" id="loginEmail" placeholder="you@example.com" required>
              </div>
              <div class="mb-3">
                <label for="loginPassword" class="form-label">Password</label>
                <input type="password" class="form-control" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
              </div>
              <button id="loginBtn" type="submit" class="btn btn-primary w-100">
                <i class="bi bi-box-arrow-in-right me-2"></i>Sign In
              </button>
            </form>
            <hr class="my-4">
            <div class="text-center">
              <p class="mb-2">Don't have an account?</p>
            </div>
            <h5 class="mb-3 text-center">Create an account</h5>
            <form id="signUpForm">
              <div class="mb-3">
                <label for="signupName" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="signupName" placeholder="Your name" required>
              </div>
              <div class="mb-3">
                <label for="signupEmail" class="form-label">Email</label>
                <input type="email" class="form-control" id="signupEmail" placeholder="you@example.com" required>
              </div>
              <div class="mb-3">
                <label for="signupPassword" class="form-label">Password</label>
                <input type="password" class="form-control" id="signupPassword" placeholder="Create a password" required>
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="termsCheck">
                <label class="form-check-label" for="termsCheck">
                  I agree to the terms and privacy policy
                </label>
                <div id="termsCheckFeedback" class="invalid-feedback" style="display:none;">
                  You must agree before signing up.
                </div>
              </div>
              <button id="signupBtn" type="submit" class="btn btn-outline-primary w-100">
                <i class="bi bi-person-plus me-2"></i>Sign Up
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="main-container">
    <div class="glass-card">
      <div class="d-flex flex-row flex-grow-1" style="min-height: 0; position: relative; overflow-y: auto;">
        <!-- Side Menu (Always visible after backend removal) -->
        <div class="side-menu nav flex-column nav-pills" id="hseTabs" role="tablist" aria-orientation="vertical" style="display: block;">
          <div class="menu-heading">MENU</div>
          
          <!-- Application Tabs (Disabled by default, enabled after auth) -->
          <button class="nav-link active" id="inspection-tab" data-bs-toggle="pill" data-bs-target="#inspection" type="button" role="tab">
            <i class="bi bi-clipboard-check me-2"></i>Inspection Report
          </button>
          <button class="nav-link" id="observations-tab" data-bs-toggle="pill" data-bs-target="#observations" type="button" role="tab">
            <i class="bi bi-eye me-2"></i>Observations
          </button>
          <button class="nav-link" id="p2411-tab" data-bs-toggle="pill" data-bs-target="#p2411" type="button" role="tab">
            <i class="bi bi-folder me-2"></i>P2411_Folder
          </button>
          <button class="nav-link" id="plant-equipment-tab" data-bs-toggle="pill" data-bs-target="#plant_equipment" type="button" role="tab">
            <i class="bi bi-tools me-2"></i>Plant & Equipment
          </button>
          <button class="nav-link" id="daily-inspections-tab" data-bs-toggle="pill" data-bs-target="#daily_inspections" type="button" role="tab">
            <i class="bi bi-clipboard2-check me-2"></i>Daily Inspections
          </button>
          <button class="nav-link" id="trainings-tab" data-bs-toggle="pill" data-bs-target="#trainings" type="button" role="tab">
            <i class="bi bi-journal-text me-2"></i>Trainings
          </button>
          <button class="nav-link" id="about-tab" data-bs-toggle="pill" data-bs-target="#aboutme" type="button" role="tab">
            <i class="bi bi-person-circle me-2"></i>About Me
          </button>
          <!-- User controls removed with backend -->
        </div>

        <!-- Tab Content -->
        <div class="tab-content flex-grow-1" id="hseTabContent">
          <!-- Authentication Tab removed in favor of full-page auth overlay (#authPage) -->
          
          <!-- Inspection Report Tab -->
          <div class="tab-pane fade show active" id="inspection" role="tabpanel">
            <h2><i class="bi bi-clipboard-check me-2"></i>HSE Inspection Report</h2>
            <form id="hseForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="location" class="form-label">Location</label>
                  <input type="text" class="form-control" id="location" placeholder="Enter inspection location" required>
                </div>
                <div class="col-md-6">
                  <label for="date" class="form-label">Date</label>
                  <input type="date" class="form-control" id="date" required>
                </div>
                <div class="col-md-6">
                  <label for="risk" class="form-label">Risk Level</label>
                  <select class="form-select" id="risk" required>
                    <option disabled selected value="">Select risk level</option>
                    <option value="Low">Low</option>
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="responsible" class="form-label">Responsible Engineer</label>
                                    <select class="form-select" id="responsible" required>
                    <option disabled selected value="">Select Engineer</option>
                    <option value="Rameez">Rameez</option>
                    <option value="Rashad">Rashad</option>
                    <option value="Elaya">Elaya</option>
                    <option value="Martin">Martin</option>
                    <option value="write_custom">Add Engneer Name</option>
                  </select>
                  <input type="text" class="form-control mt-2" id="customResponsible" placeholder="Enter engineer name" style="display: none;">
                </div>
                <div class="col-md-6">
                  <label for="inspector" class="form-label">Inspector Name</label>
                  <input type="text" class="form-control" id="inspector" placeholder="Enter inspector name" required>
                </div>
                <div class="col-12">
                  <label for="observation" class="form-label">Observation</label>
                  <textarea class="form-control" id="observation" placeholder="Describe your observation in detail..." required></textarea>
                </div>
                <div class="col-12">
                  <label for="actionTaken" class="form-label">Action Taken</label>
                  <textarea class="form-control" id="actionTaken" placeholder="Describe the corrective action taken or planned..." rows="3"></textarea>
                </div>
                <div class="col-12">
                  <label for="photo" class="form-label">Upload Photos (Optional)</label>
                  <input type="file" class="form-control" id="photo" multiple accept="image/*">
                  <div class="form-text">You can select multiple images to upload</div>
                  <div id="photoPreview" class="mt-2"></div>
                </div>
                <div class="col-12 mt-4">
                  <button type="submit" class="btn btn-primary w-100 py-2">
                    <i class="bi bi-send-check me-2"></i>Submit Report
                  </button>
                </div>
              </div>
            </form>
          </div>



          <!-- Observations Tab -->
          <div class="tab-pane fade" id="observations" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2><i class="bi bi-eye me-2"></i>Observation Records</h2>
              <div>
                <div class="input-group">
                  <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                  <input type="text" id="searchObservations" class="form-control" placeholder="Search observations..." style="max-width: 250px;">
                  <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-funnel"></i> Filter
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end p-3" style="min-width: 250px;">
                    <div class="mb-2">
                      <label class="form-label">Risk Level</label>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="High" id="filterHighRisk" checked>
                        <label class="form-check-label" for="filterHighRisk">
                          High Risk
                        </label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="Medium" id="filterMediumRisk" checked>
                        <label class="form-check-label" for="filterMediumRisk">
                          Medium Risk
                        </label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="Low" id="filterLowRisk" checked>
                        <label class="form-check-label" for="filterLowRisk">
                          Low Risk
                        </label>
                      </div>
                    </div>
                    <div class="mb-2">
                      <label for="dateRangeFilter" class="form-label">Date Range</label>
                      <select class="form-select" id="dateRangeFilter">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="custom">Custom Range</option>
                      </select>
                    </div>
                    <div class="d-grid gap-2">
                      <button class="btn btn-primary btn-sm" id="applyFilters">Apply Filters</button>
                      <button class="btn btn-outline-secondary btn-sm" id="resetFilters">Reset</button>
                      <button class="btn btn-info btn-sm mt-2" id="refreshData">Refresh Data</button>
                    </div>
                  </ul>
                </div>
              </div>
            </div>
            
            <div class="stats-container mb-4">
              <div class="stat-item">
                <div class="stat-number text-primary" id="totalObservations">0</div>
                <div class="stat-title">Total Observations</div>
              </div>
              <div class="stat-item">
                <div class="stat-number text-danger" id="highRiskCount">0</div>
                <div class="stat-title">High Risk</div>
              </div>
              <div class="stat-item">
                <div class="stat-number text-warning" id="mediumRiskCount">0</div>
                <div class="stat-title">Medium Risk</div>
              </div>
              <div class="stat-item">
                <div class="stat-number text-success" id="lowRiskCount">0</div>
                <div class="stat-title">Low Risk</div>
              </div>
            </div>
            
            
            
            <div id="observationsList" class="row g-3 mt-4">
              <!-- Observation cards will be injected here -->
            </div>
          </div>

          <!-- P2411 Folder Tab -->
          <div class="tab-pane fade" id="p2411" role="tabpanel">
            <h2><i class="bi bi-folder me-2"></i>P2411 Folders</h2>
            <div class="row g-3">
              <div class="col-md-6">
                <div class="card h-100 glass-link">
                  <div class="card-body text-center">
                    <i class="bi bi-file-earmark-slides text-primary" style="font-size: 2.5rem;"></i>
                    <h5 class="card-title mt-3">My Slides</h5>
                    <a href="https://drive.google.com/drive/folders/1-vAprXj8w3IRDTFlJCxpw7ToXw6JBJ46?usp=sharing" 
                      class="stretched-link" target="_blank"></a>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card h-100 glass-link">
                  <div class="card-body text-center">
                    <i class="bi bi-crane text-primary" style="font-size: 2.5rem;"></i>
                    <h5 class="card-title mt-3">Lifting Documents</h5>
                    <a href="https://drive.google.com/drive/folders/16Q6tteBqG-PpqHms8JO37r0swvu1X8vX?usp=sharing" 
                      class="stretched-link" target="_blank"></a>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card h-100 glass-link">
                  <div class="card-body text-center">
                    <i class="bi bi-shield-check text-primary" style="font-size: 2.5rem;"></i>
                    <h5 class="card-title mt-3">Safety Concerns</h5>
                    <a href="https://drive.google.com/drive/folders/1COg6s8vb-e6ZXM__Zgd55qHZtP1m5fAV?usp=sharing" 
                      class="stretched-link" target="_blank"></a>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card h-100 glass-link">
                  <div class="card-body text-center">
                    <i class="bi bi-gear text-primary" style="font-size: 2.5rem;"></i>
                    <h5 class="card-title mt-3">Plant Equipment</h5>
                    <a href="https://drive.google.com/drive/folders/1Kc_Gv7B9qYdODP-iHMZWETbtXSNPByDe?usp=sharing" 
                      class="stretched-link" target="_blank"></a>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Plant & Equipment Tab -->
          <div class="tab-pane fade" id="plant_equipment" role="tabpanel">
            <div class="plant-equipment-header">
              <h2><i class="bi bi-tools me-2"></i>Plant & Equipment Management</h2>
              <a href="https://docs.google.com/spreadsheets/d/1lsrJyzX-57JSUTn258ELYLT15-N8t5OS/edit?usp=sharing" 
                class="btn btn-outline-primary" target="_blank">
                <i class="bi bi-box-arrow-up-right me-1"></i>Open in Sheets
              </a>
            </div>
            
            <div class="equipment-stats">
              <div class="stat-card bg-primary bg-opacity-10 border-primary">
                <div class="stat-value text-primary">59</div>
                <div class="stat-label text-muted">Total Equipment</div>
                <div class="stat-icon">
                  <i class="bi bi-box-seam text-primary"></i>
                </div>
              </div>
              <div class="stat-card bg-success bg-opacity-10 border-success">
                <div class="stat-value text-success">18</div>
                <div class="stat-label text-muted">Active</div>
                <div class="stat-icon">
                  <i class="bi bi-check-circle text-success"></i>
                </div>
              </div>
              <div class="stat-card bg-warning bg-opacity-10 border-warning">
                <div class="stat-value text-warning">02</div>
                <div class="stat-label text-muted">Requires Inspection</div>
                <div class="stat-icon">
                  <i class="bi bi-exclamation-triangle text-warning"></i>
                </div>
              </div>
              <div class="stat-card bg-danger bg-opacity-10 border-danger">
                <div class="stat-value text-danger">00</div>
                <div class="stat-label text-muted">Maintenance</div>
                <div class="stat-icon">
                  <i class="bi bi-tools text-danger"></i>
                </div>
              </div>
            </div>
            
            <div class="equipment-tabs-container">
              <ul class="nav nav-pills nav-fill mb-4" id="equipmentTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active plant-tab d-flex align-items-center justify-content-center" id="plant-equipment-tab" data-bs-toggle="pill" data-bs-target="#plant-equipment" type="button" role="tab">
                    <i class="bi bi-tools me-2"></i>
                    <span>Plant Equipment</span>
                    <span class="badge bg-primary bg-opacity-20 text-primary ms-2">8</span>
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link power-tab d-flex align-items-center justify-content-center" id="power-machines-tab" data-bs-toggle="pill" data-bs-target="#power-machines" type="button" role="tab">
                    <i class="bi bi-lightning-charge me-2"></i>
                    <span>Power Machines</span>
                    <span class="badge bg-success bg-opacity-20 text-success ms-2">12</span>
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link fire-tab d-flex align-items-center justify-content-center" id="fire-extinguishers-tab" data-bs-toggle="pill" data-bs-target="#fire-extinguishers" type="button" role="tab">
                    <i class="bi bi-fire me-2"></i>
                    <span>Fire Safety</span>
                    <span class="badge bg-danger bg-opacity-20 text-danger ms-2">39</span>
                  </button>
                </li>
              </ul>
              
              <div class="tab-content" id="equipmentTabsContent">
                <div class="tab-pane fade show active" id="plant-equipment" role="tabpanel">
                  <h3>Plant Equipment Overview</h3>
                  <div class="equipment-grid">
                    <div class="equipment-item">
                      <div class="equipment-image mb-3">
                        <img src="crane.jpg" alt="Mobile Crane" class="img-fluid rounded" style="max-height: 150px; width: 100%; object-fit: cover;">
                      </div>
                      <h4>MOBILE CRANE</h4>
                      <div class="equipment-info">
                        <div class="info-item">
                          <span class="info-label">ID:</span>
                          <span class="info-value">EQ-0012</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Last Inspection:</span>
                          <span class="info-value">17/1/2025</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Next Due:</span>
                          <span class="info-value">16/1/2026</span>
                        </div>
                        <span class="status-badge status-active">Active</span>
                      </div>
                    </div>
                    
                    <div class="equipment-item">
                      <div class="equipment-image mb-3">
                        <img src="skid.jpg" alt="Skid Steer Loader" class="img-fluid rounded" style="max-height: 150px; width: 100%; object-fit: cover;">
                      </div>
                      <h4>SKID STEER LOADER</h4>
                      <div class="equipment-info">
                        <div class="info-item">
                          <span class="info-label">ID:</span>
                          <span class="info-value">EQ-0034</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Last Inspection:</span>
                          <span class="info-value">11/4/2025</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Next Due:</span>
                          <span class="info-value">10/4/2026</span>
                        </div>
                        <span class="status-badge status-active">Active</span>
                      </div>
                    </div>
                    
                    <div class="equipment-item">
                      <div class="equipment-icon">
                        <img src="wheel.jpg" alt="Wheel Loader" class="img-fluid rounded" style="max-height: 80px; object-fit: cover;">
                      </div>
                      <h4>WHEEL LOADER</h4>
                      <div class="equipment-info">
                        <div class="info-item">
                          <span class="info-label">ID:</span>
                          <span class="info-value">EQ-0078</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Last Inspection:</span>
                          <span class="info-value">29/5/2025</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Next Due:</span>
                          <span class="info-value">28/5/2026</span>
                        </div>
                        <span class="status-badge status-maintenance">Maintenance- Required</span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="sheet-container">
                    <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRxgJP6jRVZLno0cG-6AcOwveisbYHeKTXWZY2tmQ6q2GZVomVFFtIQvVxbZVoKhw/pubhtml?gid=1199586761&single=true"
                            allowfullscreen title="Plant Equipment Log"></iframe>
                  </div>
                </div>
                
                <div class="tab-pane fade" id="power-machines" role="tabpanel">
                  <h3>Power Machines</h3>
                  <div class="equipment-grid">
                    <div class="equipment-item">
                      <div class="equipment-icon">
                        <img src="kv.jpg" alt="Generator 500KVA" class="img-fluid rounded" style="max-height: 80px; object-fit: cover;">
                      </div>
                      <h4>GENERATOR 500KVA</h4>
                      <div class="equipment-info">
                        <div class="info-item">
                          <span class="info-label">ID:</span>
                          <span class="info-value">PM-0021</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Last Inspection:</span>
                          <span class="info-value">01/11/2025</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Next Due:</span>
                          <span class="info-value">05/6/2026</span>
                        </div>
                        <span class="status-badge status-active">Active</span>
                      </div>
                    </div>
                    
                    <div class="equipment-item">
                      <div class="equipment-icon">
                        <img src="comp.jpg" alt="Air Compressor" class="img-fluid rounded" style="max-height: 80px; object-fit: cover;">
                      </div>
                      <h4>Air Compressor</h4>
                      <div class="equipment-info">
                        <div class="info-item">
                          <span class="info-label">ID:</span>
                          <span class="info-value">PM-0045</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Last Inspection:</span>
                          <span class="info-value">28/6/2025</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Next Due:</span>
                          <span class="info-value">28/02/2026</span>
                        </div>
                        <span class="status-badge status-active">Active</span>
                      </div>
                    </div>
                    
                    <div class="equipment-item">
                      <div class="equipment-icon">
                        <img src="water.webp" alt="Water Pump" class="img-fluid rounded" style="max-height: 80px; object-fit: cover;">
                      </div>
                      <h4>Water Pump</h4>
                      <div class="equipment-info">
                        <div class="info-item">
                          <span class="info-label">ID:</span>
                          <span class="info-value">PM-0056</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Last Inspection:</span>
                          <span class="info-value">15/3/2025</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Next Due:</span>
                          <span class="info-value">15/12/2026</span>
                        </div>
                        <span class="status-badge status-active">Active</span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="sheet-container">
                    <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRxgJP6jRVZLno0cG-6AcOwveisbYHeKTXWZY2tmQ6q2GZVomVFFtIQvVxbZVoKhw/pubhtml?gid=348565325&single=true"
                            allowfullscreen title="Power Machines Log"></iframe>
                  </div>
                </div>
                
                <div class="tab-pane fade" id="fire-extinguishers" role="tabpanel">
                  <h3>Fire Safety Equipment</h3>
                  <div class="equipment-grid">
                    <div class="equipment-item">
                      <div class="equipment-icon">
                        <img src="co2.jpg" alt="CO2 Extinguisher" class="img-fluid rounded" style="max-height: 80px; object-fit: cover;">
                      </div>
                      <h4>CO2 Extinguisher</h4>
                      <div class="equipment-info">
                        <div class="info-item">
                          <span class="info-label">ID:</span>
                          <span class="info-value">FE-0011</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Location:</span>
                          <span class="info-value">Rest Area</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Expiry:</span>
                          <span class="info-value">01/01/2026</span>
                        </div>
                        <span class="status-badge status-active">Active</span>
                      </div>
                    </div>
                    
                    <div class="equipment-item">
                      <div class="equipment-icon">
                        <img src="foam.png" alt="Foam Extinguisher" class="img-fluid rounded" style="max-height: 80px; object-fit: cover;">
                      </div>
                      <h4>Foam Extinguisher</h4>
                      <div class="equipment-info">
                        <div class="info-item">
                          <span class="info-label">ID:</span>
                          <span class="info-value">FE-0033</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Location:</span>
                          <span class="info-value">Diesel tank</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Expiry:</span>
                          <span class="info-value">03/02/2026</span>
                        </div>
                        <span class="status-badge status-active">Active</span>
                      </div>
                    </div>
                    
                    <div class="equipment-item">
                      <div class="equipment-icon">
                        <img src="powder.webp" alt="Dry Powder Extinguisher" class="img-fluid rounded" style="max-height: 80px; object-fit: cover;">
                      </div>
                      <h4>Dry Powder Extinguisher</h4>
                      <div class="equipment-info">
                        <div class="info-item">
                          <span class="info-label">ID:</span>
                          <span class="info-value">FE-0055</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Location:</span>
                          <span class="info-value">Storage Area</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Expiry:</span>
                          <span class="info-value">10/12/2025</span>
                        </div>
                        <span class="status-badge status-active">Active</span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="sheet-container">
                    <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRxgJP6jRVZLno0cG-6AcOwveisbYHeKTXWZY2tmQ6q2GZVomVFFtIQvVxbZVoKhw/pubhtml?gid=71846233&single=true"
                            allowfullscreen title="Fire Extinguishers Log"></iframe>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Daily Inspections Tab -->
          <div class="tab-pane fade" id="daily_inspections" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2><i class="bi bi-clipboard2-check me-2"></i>Daily Inspections</h2>
              <div>
                <button class="btn btn-primary" id="refreshInspectionBtn">
                  <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                </button>
              </div>
            </div>
            
            <!-- Company Overview -->
            <div class="card border-0 shadow-sm mb-4">
              <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-building me-2"></i>Current plant equipments</h5>
                <div class="d-flex align-items-center">
                  <small class="me-2">Inspection Count:</small>
                  <span class="badge bg-success me-1">Low</span>
                  <span class="badge bg-warning me-1">Medium</span>
                  <span class="badge bg-danger">High</span>
                </div>
              </div>
              <div class="card-body p-0">
                <div class="row g-0 text-center">
                  <!-- Infra -->
                  <div class="col-6 col-md-4 col-lg-2 p-3 border-end border-bottom" data-count="2">
                    <div class="h5 mb-1">Infra</div>
                    <div class="h3 fw-bold">2</div>
                    <small class="text-muted">equipments</small>
                  </div>
                  <!-- ICDC -->
                  <div class="col-6 col-md-4 col-lg-2 p-3 border-end border-bottom" data-count="8">
                    <div class="h5 mb-1">ICDC</div>
                    <div class="h3 fw-bold">8</div>
                    <small class="text-muted">equipments</small>
                  </div>
                  <!-- MEDI -->
                  <div class="col-6 col-md-4 col-lg-2 p-3 border-end border-bottom" data-count="1">
                    <div class="h5 mb-1">Medi</div>
                    <div class="h3 fw-bold">1</div>
                    <small class="text-muted">equipments</small>
                  </div>
                  <!-- NPC -->
                  <div class="col-6 col-md-4 col-lg-2 p-3 border-end border-bottom" data-count="9">
                    <div class="h5 mb-1">NPC</div>
                    <div class="h3 fw-bold">9</div>
                    <small class="text-muted">equipments</small>
                  </div>
                  <!-- SOIL TEC -->
                  <div class="col-6 col-md-4 col-lg-2 p-3 border-end border-bottom" data-count="3">
                    <div class="h5 mb-1">SOIL TEC</div>
                    <div class="h3 fw-bold">3</div>
                    <small class="text-muted">equipments</small>
                  </div>
                  <!-- FIT WELL -->
                  <div class="col-6 col-md-4 col-lg-2 p-3 border-end border-bottom" data-count="2">
                    <div class="h5 mb-1">FIT WELL</div>
                    <div class="h3 fw-bold">2</div>
                    <small class="text-muted">equipments</small>
                  </div>
                  <!-- Total -->
                  <div class="col-6 col-md-4 col-lg-2 p-3 bg-light" data-count="23">
                    <div class="h5 mb-1">Total</div>
                    <div class="h3 fw-bold">23</div>
                    <small class="text-muted">equipments</small>
                  </div>
                </div>
              </div>
            </div>
            
            <style>
              /* Dynamic coloring based on inspection count */
              [data-count] {
                transition: all 0.3s ease;
              }
              [data-count] .h3 {
                transition: all 0.3s ease;
              }
              [data-count="2"] .h3 { color: #28a745; } /* Green for low */
              [data-count="3"] .h3 { color: #28a745; } /* Green for low */
              [data-count="8"] .h3 { color: #ffc107; } /* Yellow for medium */
              [data-count="9"] .h3 { color: #dc3545; } /* Red for high */
              [data-count="25"] .h3 { color: #0d6efd; } /* Blue for total */
              
              /* Hover effects */
              [data-count]:not([data-count="25"]):hover {
                background-color: rgba(0,0,0,0.02);
                transform: translateY(-2px);
              }
              [data-count]:not([data-count="25"]) .h3 {
                transform: scale(1.1);
              }
            </style>
            
            <style>
              /* Custom styles for Plant & Equipment tabs */
              /* Tab Styling */
              .equipment-tabs-container .nav-pills {
                background: #f8f9fa;
                padding: 0.5rem;
                border-radius: 50px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.05);
              }
              
              .equipment-tabs-container .nav-link {
                border-radius: 50px;
                padding: 0.75rem 1.25rem;
                margin: 0 0.25rem;
                color: #6c757d;
              }
              .nav-tabs .nav-link.power-tab.active {
                color: #198754;
                border-color: #dee2e6 #dee2e6 #fff;
                border-bottom: 3px solid #198754;
              }
              .nav-tabs .nav-link.fire-tab {
                color: #dc3545;
                border-color: #dee2e6 #dee2e6 #fff;
              }
              .nav-tabs .nav-link.fire-tab.active {
                color: #dc3545;
                background-color: rgba(220, 53, 69, 0.1);
                border-color: #dee2e6 #dee2e6 #fff;
                border-bottom: 3px solid #dc3545;
              }
              .nav-tabs .nav-link {
                font-weight: 500;
                transition: all 0.2s ease;
              }
              .nav-tabs .nav-link:hover:not(.active) {
                background-color: rgba(0, 0, 0, 0.03);
              }
            </style>
            
            <div class="card border-0 shadow-sm mb-4">
              <div class="card-body p-0">
                <div class="ratio ratio-16x9">
                  <iframe 
                    src="https://docs.google.com/spreadsheets/d/1ITOpU26xc3xv3vK9_hRtRfD7REWaixlRfIaIcFgOaSo/edit?rm=minimal&single=true&widget=true&headers=false&chrome=false"
                    style="border: none;"
                    allowfullscreen>
                  </iframe>
                </div>
              </div>
            </div>
            
            <div class="alert alert-info d-flex align-items-center" role="alert">
              <i class="bi bi-info-circle-fill me-2"></i>
              <div>
                
              </div>
            </div>
          </div>

          <!-- Trainings Tab -->
          <div class="tab-pane fade" id="trainings" role="tabpanel">
            <div class="container py-4">
              <div class="training-header mb-4">
                <h2><i class="bi bi-mortarboard me-2"></i>Training Management</h2>
              </div>
              
              <!-- Training Stats Overview -->
              <div class="training-stats mb-5">
                <div class="row g-4">
                  <div class="col-md-3">
                    <div class="stat-card bg-primary bg-opacity-10 border-primary">
                      <div class="stat-value text-primary">127</div>
                      <div class="stat-label text-muted">Total Trainings</div>
                      <div class="stat-icon">
                        <i class="bi bi-journal-text text-primary"></i>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="stat-card bg-success bg-opacity-10 border-success">
                      <div class="stat-value text-success">0</div>
                      <div class="stat-label text-muted">Completed</div>
                      <div class="stat-icon">
                        <i class="bi bi-check-circle text-success"></i>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="stat-card bg-warning bg-opacity-10 border-warning">
                      <div class="stat-value text-warning">0</div>
                      <div class="stat-label text-muted">Upcoming</div>
                      <div class="stat-icon">
                        <i class="bi bi-calendar-week text-warning"></i>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="stat-card bg-info bg-opacity-10 border-info">
                      <div class="stat-value text-info">0</div>
                      <div class="stat-label text-muted">Certifications</div>
                      <div class="stat-icon">
                        <i class="bi bi-award text-info"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Tabs Navigation -->
              <ul class="nav nav-pills nav-fill mb-4" id="trainingTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active d-flex align-items-center justify-content-center" id="trainings-done-tab" data-bs-toggle="pill" data-bs-target="#trainings-done-pane" type="button" role="tab">
                    <i class="bi bi-list-check me-2"></i>
                    <span>Trainings Done</span>
                    <span class="badge bg-purple bg-opacity-20 text-purple ms-2">127</span>
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link d-flex align-items-center justify-content-center" id="toolbox-tab" data-bs-toggle="pill" data-bs-target="#toolbox-tab-pane" type="button" role="tab">
                    <i class="bi bi-chat-square-text me-2"></i>
                    <span>Toolbox Talk</span>
                    <span class="badge bg-primary bg-opacity-20 text-primary ms-2">42</span>
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link d-flex align-items-center justify-content-center" id="environmental-tab" data-bs-toggle="pill" data-bs-target="#environmental-tab-pane" type="button" role="tab">
                    <i class="bi bi-tree me-2"></i>
                    <span>Environmental</span>
                    <span class="badge bg-success bg-opacity-20 text-success ms-2">38</span>
                  </button>
                </li>
              </ul>
              <script>
              // Initialize training forms and event listeners
              document.addEventListener('DOMContentLoaded', async function() {
                try {
                  initTrainingForms();
                  await loadTrainings();
                  await loadToolboxTalks();
                  initCalendar();
                  
                  // Update stats when the Trainings tab is shown
                  const trainingsTab = document.getElementById('trainings-tab');
                  if (trainingsTab) {
                    trainingsTab.addEventListener('shown.bs.tab', async function() {
                      await updateTrainingStats();
                    });
                  }
                  
                  // Also update when the Trainings Done tab is shown
                  const trainingsDoneTab = document.getElementById('trainings-done-tab');
                  if (trainingsDoneTab) {
                    trainingsDoneTab.addEventListener('shown.bs.tab', async function() {
                      await updateTrainingStats();
                    });
                  }
                } catch (error) {
                  console.error('Error initializing training module:', error);
                }
              });
                
                // Update training statistics based on Supabase data
                async function updateTrainingStats() {
                  try {
                    // Get references to the stats elements
                    const totalTrainingsEl = document.querySelector('.training-stats .stat-value:nth-child(1)');
                    const completedTrainingsEl = document.querySelector('.training-stats .stat-value:nth-child(2)');
                    const upcomingTrainingsEl = document.querySelector('.training-stats .stat-value:nth-child(3)');
                    const certificationsEl = document.querySelector('.training-stats .stat-value:nth-child(4)');

                    const { data, error } = await supabase
                      .from('trainings')
                      .select('*');
                    if (error) throw error;
                    const allTrainings = Array.isArray(data) ? data : [];

                    const now = new Date();
                    const completedTrainings = allTrainings.filter(training => 
                      training.status === 'completed' || 
                      (training.completionDate && new Date(training.completionDate) <= now)
                    );
                    const upcomingTrainings = allTrainings.filter(training => 
                      training.status === 'scheduled' || 
                      (training.trainingDate && new Date(training.trainingDate) > now) ||
                      (training.date && new Date(training.date) > now)
                    );
                    const certifications = allTrainings.filter(training => 
                      training.isCertification === true || 
                      training.type === 'certification'
                    );

                    if (totalTrainingsEl) totalTrainingsEl.textContent = allTrainings.length;
                    if (completedTrainingsEl) completedTrainingsEl.textContent = completedTrainings.length;
                    if (upcomingTrainingsEl) upcomingTrainingsEl.textContent = upcomingTrainings.length;
                    if (certificationsEl) certificationsEl.textContent = certifications.length;

                    const trainingsDoneTab = document.getElementById('trainings-done-tab');
                    const toolboxTab = document.getElementById('toolbox-tab');
                    const environmentalTab = document.getElementById('environmental-tab');
                    if (trainingsDoneTab) {
                      const badge = trainingsDoneTab.querySelector('.badge');
                      if (badge) badge.textContent = allTrainings.length;
                    }
                    if (toolboxTab) {
                      const badge = toolboxTab.querySelector('.badge');
                      if (badge) badge.textContent = allTrainings.filter(t => t.type === 'toolbox-talk').length;
                    }
                    if (environmentalTab) {
                      const badge = environmentalTab.querySelector('.badge');
                      if (badge) badge.textContent = allTrainings.filter(t => t.type === 'environmental-training').length;
                    }
                    return true;
                  } catch (error) {
                    console.error('Error updating training statistics:', error);
                    return false;
                  }
                }
              </script>
              
              <style>
                /* Training Tab Styling */
                .training-header {
                  margin-bottom: 2rem;
                }
                
                .training-header h2 {
                  color: #2c3e50;
                  font-weight: 700;
                }
                
                .training-stats .stat-card {
                  height: 100%;
                  transition: all 0.3s ease;
                }
                
                .training-stats .stat-card:hover {
                  transform: translateY(-5px);
                  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
                }
                
                /* Tab Styling */
                #trainingTabs {
                  background: #f8f9fa;
                  padding: 0.5rem;
                  border-radius: 50px;
                  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                }
                
                #trainingTabs .nav-link {
                  border-radius: 50px;
                  padding: 0.75rem 1.25rem;
                  margin: 0 0.25rem;
                  color: #6c757d;
                  font-weight: 500;
                  transition: all 0.3s ease;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  position: relative;
                  overflow: hidden;
                }
                
                #trainingTabs .nav-link:hover:not(.active) {
                  background: rgba(255,255,255,0.8);
                  transform: translateY(-2px);
                }
                
                #trainingTabs .nav-link.active {
                  color: #fff;
                  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                  transform: translateY(-2px);
                }
                
                /* Trainings Done Tab */
                #trainingTabs .nav-link.active[data-bs-target="#trainings-done-pane"] {
                  background: linear-gradient(135deg, #6f42c1, #4e2a84) !important;
                  border-color: #4e2a84 !important;
                }
                
                /* Toolbox Talk Tab */
                #trainingTabs .nav-link[data-bs-target="#toolbox-tab-pane"] {
                  color: #0d6efd;
                }
                #trainingTabs .nav-link.active[data-bs-target="#toolbox-tab-pane"] {
                  background: linear-gradient(135deg, #0d6efd, #0a58ca) !important;
                  border-color: #0a58ca !important;
                }
                
                /* Environmental Tab */
                #trainingTabs .nav-link[data-bs-target="#environmental-tab-pane"] {
                  color: #198754;
                }
                #trainingTabs .nav-link.active[data-bs-target="#environmental-tab-pane"] {
                  background: linear-gradient(135deg, #198754, #146c43) !important;
                  border-color: #146c43 !important;
                }
                
                /* Tab Icons */
                #trainingTabs .nav-link i {
                  transition: all 0.3s ease;
                }
                
                #trainingTabs .nav-link.active i {
                  transform: scale(1.2);
                }
                
                /* Purple theme for Trainings Done */
                .bg-purple {
                  background-color: #6f42c1 !important;
                }
                
                .text-purple {
                  color: #6f42c1 !important;
                }
                
                .border-purple {
                  border-color: #6f42c1 !important;
                }
              </style>
              
              <!-- Tabs Content -->
              <div class="tab-content" id="trainingTabsContent">
                <!-- Trainings Done Tab -->
                <div class="tab-pane fade show active" id="trainings-done-pane" role="tabpanel" aria-labelledby="trainings-done-tab">
                  <div class="card shadow-sm border-0">
                    <div class="card-header bg-purple text-white">
                      <h3 class="mb-0"><i class="bi bi-list-check me-2"></i>Trainings Done</h3>
                    </div>
                    <div class="card-body">
                      <!-- Search and Filter Bar -->
                      <div class="row mb-4">
                        <div class="col-md-6 mb-2">
                          <div class="input-group">
                            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="trainingSearch" placeholder="Search trainings...">
                          </div>
                        </div>
                        <div class="col-md-3 mb-2">
                          <select class="form-select" id="trainingFilterType">
                            <option value="all">All Types</option>
                            <option value="toolbox">Toolbox Talks</option>
                            <option value="environmental">Environmental</option>
                          </select>
                        </div>
                        <div class="col-md-3 mb-2">
                          <select class="form-select" id="trainingFilterStatus">
                            <option value="all">All Statuses</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="completed">Completed</option>
                            <option value="in-progress">In Progress</option>
                            <option value="cancelled">Cancelled</option>
                          </select>
                        </div>
                      </div>
                      
                      <!-- Results Count -->
                      <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="text-muted small">
                          Showing <span id="trainingResultsCount" class="fw-bold">0</span> results
                        </div>
                        <div>
                          <button class="btn btn-outline-secondary btn-sm" id="exportTrainingsBtn">
                            <i class="bi bi-download me-1"></i>Export to CSV
                          </button>
                        </div>
                      </div>
                      
                      <!-- Trainings Table -->
                      <div class="table-responsive">
                        <table class="table table-hover align-middle">
                          <thead class="table-light">
                            <tr>
                              <th>Training</th>
                              <th>Date & Time</th>
                              <th>Category</th>
                              <th>Location</th>
                              <th>Status</th>
                              <th class="text-end">Actions</th>
                            </tr>
                          </thead>
                          <tbody id="trainingsList">
                            <!-- Trainings will be loaded here -->
                          </tbody>
                        </table>
                      </div>
                      
                      <!-- Pagination -->
                      <nav class="mt-4" aria-label="Trainings pagination">
                        <ul class="pagination justify-content-center">
                          <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                          </li>
                          <li class="page-item active"><a class="page-link" href="#">1</a></li>
                          <li class="page-item"><a class="page-link" href="#">2</a></li>
                          <li class="page-item"><a class="page-link" href="#">3</a></li>
                          <li class="page-item">
                            <a class="page-link" href="#">Next</a>
                          </li>
                        </ul>
                      </nav>
                    </div>
                  </div>
                </div>
                
                <!-- Toolbox Talk Tab -->
                <div class="tab-pane fade" id="toolbox-tab-pane" role="tabpanel" aria-labelledby="toolbox-tab">
                  <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                      <h3 class="mb-0"><i class="bi bi-chat-square-text me-2"></i>Toolbox Talks</h3>
                      <button class="btn btn-light btn-sm" onclick="loadToolboxTalks()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                      </button>
                    </div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-hover align-middle">
                          <thead class="table-light">
                            <tr>
                              <th>Topic</th>
                              <th>Date</th>
                              <th>Presenter</th>
                              <th>Location</th>
                              <th class="text-end">Actions</th>
                            </tr>
                          </thead>
                          <tbody id="toolboxTalksList">
                            <!-- Toolbox talks will be loaded here -->
                            <tr>
                              <td colspan="5" class="text-center py-4 text-muted">
                                <div class="spinner-border spinner-border-sm" role="status">
                                  <span class="visually-hidden">Loading...</span>
                                </div>
                                <span class="ms-2">Loading toolbox talks...</span>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Add New Toolbox Talk Card -->
                  <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white">
                      <h3 class="mb-0"><i class="bi bi-plus-circle me-2"></i>New Toolbox Talk</h3>
                    </div>
                    <div class="card-body">
                      <form id="toolboxTalkForm">
                        <div class="row g-3">
                          <!-- Topic Information -->
                          <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">Topic Information</h5>
                          </div>
                          
                          <div class="col-md-6">
                            <div class="form-floating">
                              <input type="text" class="form-control" id="talkTopic" placeholder="Enter topic title" required>
                              <label for="talkTopic">Topic Title</label>
                            </div>
                          </div>
                          
                          <div class="col-md-6">
                            <div class="form-floating">
                              <select class="form-select" id="talkCategory" required>
                                <option value="">Select category</option>
                                <option value="safety">Safety Procedures</option>
                                <option value="hazard">Hazard Identification</option>
                                <option value="ppe">PPE Requirements</option>
                                <option value="emergency">Emergency Procedures</option>
                                <option value="environmental">Environmental Awareness</option>
                                <option value="other">Other</option>
                              </select>
                              <label for="talkCategory">Category</label>
                            </div>
                          </div>
                          
                          <!-- Date & Time -->
                          <div class="col-12 mt-4">
                            <h5 class="border-bottom pb-2 mb-3">Schedule</h5>
                          </div>
                          
                          <div class="col-md-4">
                            <div class="form-floating">
                              <input type="date" class="form-control" id="talkDate" required>
                              <label for="talkDate">Date</label>
                            </div>
                          </div>
                          
                          <div class="col-md-4">
                            <div class="form-floating">
                              <input type="time" class="form-control" id="talkTime" required>
                              <label for="talkTime">Start Time</label>
                            </div>
                          </div>
                          
                          <div class="col-md-4">
                            <div class="form-floating">
                              <input type="number" class="form-control" id="talkDuration" min="15" max="240" value="30" required>
                              <label for="talkDuration">Duration (minutes)</label>
                            </div>
                          </div>
                          
                          <!-- Location & Presenter -->
                          <div class="col-12 mt-4">
                            <h5 class="border-bottom pb-2 mb-3">Location & Presenter</h5>
                          </div>
                          
                          <div class="col-md-6">
                            <div class="form-floating">
                              <select class="form-select" id="talkLocation" required>
                                <option value="">Select location</option>
                                <option value="site-office">Site Office</option>
                                <option value="workshop">Workshop</option>
                                <option value="onsite">On-site Location</option>
                                <option value="online">Online Meeting</option>
                              </select>
                              <label for="talkLocation">Location</label>
                            </div>
                          </div>
                          
                          <div class="col-md-6">
                            <div class="form-floating">
                              <input type="text" class="form-control" id="talkPresenter" placeholder="Enter presenter name" required>
                              <label for="talkPresenter">Presenter Name</label>
                            </div>
                          </div>
                          
                          <!-- Talk Details -->
                          <div class="col-12 mt-4">
                            <h5 class="border-bottom pb-2 mb-3">Talk Details</h5>
                          </div>
                          
                          <div class="col-12">
                            <div class="form-floating">
                              <textarea class="form-control" id="talkObjectives" style="height: 100px;" placeholder="Enter learning objectives" required></textarea>
                              <label for="talkObjectives">Learning Objectives</label>
                            </div>
                          </div>
                          
                          <div class="col-12">
                            <div class="form-floating">
                              <textarea class="form-control" id="talkContent" style="height: 150px;" placeholder="Enter talk content" required></textarea>
                              <label for="talkContent">Talk Content</label>
                            </div>
                          </div>
                          
                          <!-- Safety Considerations -->
                          <div class="col-12 mt-4">
                            <h5 class="border-bottom pb-2 mb-3">Safety Considerations</h5>
                          </div>
                          
                          <div class="col-12">
                            <div class="form-floating">
                              <textarea class="form-control" id="safetyConsiderations" style="height: 100px;" placeholder="Enter safety considerations"></textarea>
                              <label for="safetyConsiderations">Safety Considerations</label>
                            </div>
                          </div>
                          
                          <!-- Attendees -->
                          <div class="col-12 mt-4">
                            <h5 class="border-bottom pb-2 mb-3">Attendees</h5>
                          </div>
                          
                          <div class="col-12">
                            <div class="form-floating">
                              <input type="text" class="form-control" id="attendeeSearch" placeholder="Search for attendees">
                              <label for="attendeeSearch">Search Attendees</label>
                            </div>
                            <div id="attendeeList" class="mt-2">
                              <!-- Attendee checkboxes will be added here by JavaScript -->
                            </div>
                          </div>
                          
                          <!-- Actions -->
                          <div class="col-12 mt-4 pt-3 border-top">
                            <div class="d-flex justify-content-end gap-2">
                              <button type="reset" class="btn btn-outline-secondary">
                                <i class="bi bi-x-lg me-1"></i> Clear
                              </button>
                              <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-1"></i> Save Toolbox Talk
                              </button>
                            </div>
                          </div>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                
                <!-- Environmental Training Tab -->
                <div class="tab-pane fade" id="environmental-tab-pane" role="tabpanel" aria-labelledby="environmental-tab">
                  <div class="card shadow-sm border-0">
                    <div class="card-header bg-success text-white">
                      <h3 class="mb-0"><i class="bi bi-tree me-2"></i>Environmental Training</h3>
                    </div>
                    <div class="card-body">
                      <form id="environmentalTrainingForm">
                        <div class="row g-3">
                          <!-- Training Details -->
                          <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">Training Details</h5>
                          </div>
                          
                          <div class="col-md-6">
                            <div class="form-floating">
                              <input type="text" class="form-control" id="trainingTitle" placeholder="Enter training title" required>
                              <label for="trainingTitle">Training Title</label>
                            </div>
                          </div>
                          
                          <div class="col-md-6">
                            <div class="form-floating">
                              <select class="form-select" id="trainingType" required>
                                <option value="">Select training type</option>
                                <option value="awareness">Environmental Awareness</option>
                                <option value="compliance">Regulatory Compliance</option>
                                <option value="certification">Professional Certification</option>
                                <option value="safety">Environmental Safety</option>
                                <option value="other">Other</option>
                              </select>
                              <label for="trainingType">Training Type</label>
                            </div>
                          </div>
                          
                          <!-- Schedule -->
                          <div class="col-12 mt-4">
                            <h5 class="border-bottom pb-2 mb-3">Schedule & Provider</h5>
                          </div>
                          
                          <div class="col-md-4">
                            <div class="form-floating">
                              <input type="date" class="form-control" id="trainingDate" required>
                              <label for="trainingDate">Training Date</label>
                            </div>
                          </div>
                          
                          <div class="col-md-4">
                            <div class="form-floating">
                              <input type="time" class="form-control" id="trainingTime" required>
                              <label for="trainingTime">Start Time</label>
                            </div>
                          </div>
                          
                          <div class="col-md-4">
                            <div class="form-floating">
                              <input type="number" class="form-control" id="trainingDuration" min="15" step="15" value="60" required>
                              <label for="trainingDuration">Duration (minutes)</label>
                            </div>
                          </div>
                          
                          <div class="col-md-6">
                            <div class="form-floating">
                              <input type="text" class="form-control" id="trainingProvider" placeholder="Enter provider name" required>
                              <label for="trainingProvider">Training Provider</label>
                            </div>
                          </div>
                          
                          <div class="col-md-6">
                            <div class="form-floating">
                              <input type="text" class="form-control" id="trainingLocation" placeholder="Enter location" required>
                              <label for="trainingLocation">Location</label>
                            </div>
                          </div>
                          
                          <!-- Environmental Focus Areas -->
                          <div class="col-12 mt-4">
                            <h5 class="border-bottom pb-2 mb-3">Environmental Focus Areas</h5>
                          <p class="text-muted small">Select all that apply</p>
                            <div id="focusAreasContainer" class="row g-3"></div>
                          </div>
                          
                          <!-- Training Description -->
                          <div class="col-12 mt-4">
                            <h5 class="border-bottom pb-2 mb-3">Training Description</h5>
                            <div class="form-floating">
                              <textarea class="form-control" id="trainingDescription" style="height: 120px;" placeholder="Enter training description" required></textarea>
                              <label for="trainingDescription">Training Description & Objectives</label>
                            </div>
                            <div class="form-text">Provide a brief overview of the training content and learning objectives</div>
                          </div>
                          
                          <!-- Participants -->
                          <div class="col-12 mt-4">
                            <h5 class="border-bottom pb-2 mb-3">Participants</h5>
                            <div class="table-responsive">
                              <table class="table table-sm table-hover" id="participantsTable">
                                <thead>
                                  <tr>
                                    <th>Name</th>
                                    <th>Department</th>
                                    <th>Employee ID</th>
                                    <th>Action</th>
                                  </tr>
                                </thead>
                                <tbody id="participantsList">
                                  <!-- Participants will be added here dynamically -->
                                </tbody>
                              </table>
                            </div>
                            
                            <div class="row g-3 mt-2">
                              <div class="col-md-4">
                                <input type="text" class="form-control" id="participantName" placeholder="Full Name">
                              </div>
                              <div class="col-md-3">
                                <input type="text" class="form-control" id="participantDept" placeholder="Department">
                              </div>
                              <div class="col-md-3">
                                <input type="text" class="form-control" id="participantId" placeholder="Employee ID">
                              </div>
                              <div class="col-md-2">
                                <button type="button" class="btn btn-outline-primary w-100" id="addParticipantBtn" onclick="addParticipant()">
                                  <i class="bi bi-plus-lg"></i> Add
                                </button>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Training Materials -->
                          <div class="col-12 mt-4">
                            <h5 class="border-bottom pb-2 mb-3">Training Materials</h5>
                            
                            <div class="mb-3">
                              <label for="trainingMaterials" class="form-label">Upload Materials</label>
                              <input class="form-control" type="file" id="trainingMaterials" multiple>
                              <div class="form-text">Upload presentation slides, handouts, or reference materials (PDF, PPT, DOC, etc.)</div>
                            </div>
                            
                            <div class="mb-3">
                              <label for="resourceLinks" class="form-label">Resource Links</label>
                              <div id="resourceLinksContainer">
                                <div class="input-group mb-2">
                                  <input type="url" class="form-control" placeholder="https://example.com/resource">
                                  <button class="btn btn-outline-danger" type="button">
                                    <i class="bi bi-trash"></i>
                                  </button>
                                </div>
                              </div>
                              <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="addResourceLinkBtn">
                                <i class="bi bi-plus-lg me-1"></i>Add Resource Link
                              </button>
                            </div>
                          </div>
                          
                          <!-- Assessment & Certification -->
                          <div class="col-12 mt-4">
                            <h5 class="border-bottom pb-2 mb-3">Assessment & Certification</h5>
                            
                            <div class="row g-3">
                              <div class="col-md-6">
                                <div class="form-floating">
                                  <select class="form-select" id="assessmentType">
                                    <option value="none">No Assessment</option>
                                    <option value="quiz">Quiz/Test</option>
                                    <option value="practical">Practical Evaluation</option>
                                    <option value="attendance">Attendance Only</option>
                                    <option value="other">Other</option>
                                  </select>
                                  <label for="assessmentType">Assessment Method</label>
                                </div>
                              </div>
                              
                              <div class="col-md-6">
                                <div class="form-floating">
                                  <input type="number" class="form-control" id="passingScore" min="0" max="100" value="70">
                                  <label for="passingScore">Passing Score (%)</label>
                                </div>
                              </div>
                              
                              <div class="col-12">
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" id="issueCertification">
                                  <label class="form-check-label" for="issueCertification">
                                    Issue certification upon completion
                                  </label>
                                </div>
                              </div>
                              
                              <div class="col-12" id="certificationFields" style="display: none;">
                                <div class="row g-3">
                                  <div class="col-md-6">
                                    <div class="form-floating">
                                      <input type="text" class="form-control" id="certificateTemplate" placeholder="e.g., CERT-ENV-001">
                                      <label for="certificateTemplate">Certificate Template ID</label>
                                    </div>
                                  </div>
                                  <div class="col-md-6">
                                    <div class="form-floating">
                                      <input type="number" class="form-control" id="validityPeriod" min="0" value="12">
                                      <label for="validityPeriod">Validity Period (months)</label>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Follow-up Actions -->
                          <div class="col-12 mt-4">
                            <h5 class="border-bottom pb-2 mb-3">Follow-up Actions</h5>
                            
                            <div class="row g-3">
                              <div class="col-md-6">
                                <div class="form-floating">
                                  <input type="date" class="form-control" id="nextReviewDate">
                                  <label for="nextReviewDate">Next Review Date</label>
                                </div>
                              </div>
                              
                              <div class="col-md-6">
                                <div class="form-floating">
                                  <select class="form-select" id="responsiblePerson">
                                    <option value="">Select responsible person</option>
                                    <!-- Will be populated dynamically -->
                                  </select>
                                  <label for="responsiblePerson">Responsible Person</label>
                                </div>
                              </div>
                              
                              <div class="col-12">
                                <div class="form-floating">
                                  <textarea class="form-control" id="actionItems" style="height: 100px;" placeholder="Enter action items"></textarea>
                                  <label for="actionItems">Action Items & Notes</label>
                                </div>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Form Actions -->
                          <div class="col-12 mt-4 pt-3 border-top">
                            <div class="d-flex justify-content-between">
                              <button type="button" class="btn btn-outline-secondary" id="resetEnvTrainingForm">
                                <i class="bi bi-arrow-counterclockwise me-1"></i>Reset Form
                              </button>
                              <div>
                                <button type="button" class="btn btn-outline-primary me-2">
                                  <i class="bi bi-save me-1"></i>Save Draft
                                </button>
                                <button type="submit" class="btn btn-success">
                                  <i class="bi bi-check-lg me-1"></i>Submit Training
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                
                <!-- Trainings Done Tab -->
                <div class="tab-pane fade" id="trainings-done-pane" role="tabpanel" aria-labelledby="trainings-done-tab">
                  <div class="card shadow-sm border-0">
                    <div class="card-header bg-purple text-white">
                      <h3 class="mb-0"><i class="bi bi-list-check me-2"></i>Trainings Done</h3>
                    </div>
                    <div class="card-body">
                      <!-- Search and Filter Bar -->
                      <div class="row mb-4 g-3">
                        <div class="col-md-6">
                          <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="trainingSearch" placeholder="Search trainings...">
                          </div>
                        </div>
                        <div class="col-md-3">
                          <select class="form-select" id="trainingTypeFilter">
                            <option value="">All Types</option>
                            <option value="toolbox">Toolbox Talk</option>
                            <option value="environmental">Environmental Training</option>
                            <option value="other">Other</option>
                          </select>
                        </div>
                        <div class="col-md-3">
                          <select class="form-select" id="trainingDateFilter">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                          </select>
                        </div>
                      </div>
                      
                      <!-- Training Reports Table -->
                      <div class="table-responsive">
                        <table class="table table-hover align-middle" id="trainingsTable">
                          <thead class="table-light">
                            <tr>
                              <th>#</th>
                              <th>Training Title</th>
                              <th>Type</th>
                              <th>Date</th>
                              <th>Participants</th>
                              <th>Duration</th>
                              <th>Status</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody id="trainingsList">
                            <!-- Training records will be loaded here -->
                            <tr>
                              <td colspan="8" class="text-center text-muted py-4">
                                <i class="bi bi-inbox display-6 d-block mb-2"></i>
                                No training records found
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                      
                      <!-- Pagination -->
                      <nav aria-label="Training pagination" class="mt-4">
                        <ul class="pagination justify-content-center">
                          <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                          </li>
                          <li class="page-item active"><a class="page-link" href="#">1</a></li>
                          <li class="page-item"><a class="page-link" href="#">2</a></li>
                          <li class="page-item"><a class="page-link" href="#">3</a></li>
                          <li class="page-item">
                            <a class="page-link" href="#">Next</a>
                          </li>
                        </ul>
                      </nav>
                      
                      <!-- Export Options -->
                      <div class="d-flex justify-content-end mt-3">
                        <div class="btn-group">
                          <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-download me-2"></i>Export
                          </button>
                          <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-pdf me-2"></i>PDF</a></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-excel me-2"></i>Excel</a></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-text me-2"></i>CSV</a></li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Add/Edit Training Modal -->
          <div class="modal fade" id="addTrainingModal" tabindex="-1" aria-labelledby="addTrainingModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header bg-light">
                  <h5 class="modal-title" id="addTrainingModalLabel">Schedule Toolbox Talk</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                  <form id="trainingForm">
                    <input type="hidden" id="trainingId">
                    
                    <div class="row g-3">
                      <div class="col-12">
                        <div class="form-floating">
                          <input type="text" class="form-control" id="trainingTitle" placeholder="Enter topic title" required>
                          <label for="trainingTitle" class="form-label">Topic Title</label>
                        </div>
                      </div>
                      
                      <div class="col-md-6">
                        <div class="form-floating">
                          <input type="date" class="form-control" id="trainingDate" required>
                          <label for="trainingDate">Scheduled Date</label>
                        </div>
                      </div>
                      
                      <div class="col-md-6">
                        <div class="form-floating">
                          <input type="time" class="form-control" id="trainingTime" required>
                          <label for="trainingTime">Start Time</label>
                        </div>
                      </div>
                      
                      <div class="col-md-6">
                        <div class="form-floating">
                          <input type="text" class="form-control" id="trainingInstructor" placeholder="Enter presenter name" required>
                          <label for="trainingInstructor">Presenter</label>
                        </div>
                      </div>
                      
                      <div class="col-md-6">
                        <div class="form-floating">
                          <select class="form-select" id="trainingLocation" required>
                            <option value="">Select location</option>
                            <option value="site-office">Site Office</option>
                            <option value="workshop">Workshop</option>
                            <option value="onsite">On-site Location</option>
                            <option value="online">Online Meeting</option>
                          </select>
                          <label for="trainingLocation">Location</label>
                        </div>
                      </div>
                      
                      <div class="col-12">
                        <div class="form-floating">
                          <select class="form-select" id="trainingCategory" required>
                            <option value="">Select category</option>
                            <option value="safety">Safety Procedures</option>
                            <option value="equipment">Equipment Usage</option>
                            <option value="hazard">Hazard Identification</option>
                            <option value="emergency">Emergency Procedures</option>
                            <option value="ppe">PPE Requirements</option>
                            <option value="environmental">Environmental Awareness</option>
                            <option value="other">Other</option>
                          </select>
                          <label for="trainingCategory">Category</label>
                        </div>
                      </div>
                      
                      <div class="col-12">
                        <div class="form-floating">
                          <textarea class="form-control" id="trainingDescription" placeholder="Enter key points to cover" style="height: 100px;" required></textarea>
                          <label for="trainingDescription">Key Points to Cover</label>
                        </div>
                      </div>
                      
                      <div class="col-12">
                        <div class="form-floating">
                          <textarea class="form-control" id="safetyConsiderations" placeholder="Enter safety considerations" style="height: 80px;"></textarea>
                          <label for="safetyConsiderations">Safety Considerations</label>
                        </div>
                      </div>
                      
                      <div class="col-12">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" id="safetyEquipmentRequired">
                          <label class="form-check-label" for="safetyEquipmentRequired">Safety Equipment Required</label>
                        </div>
                      </div>
                      
                      <div class="col-12" id="equipmentListContainer" style="display: none;">
                        <div class="form-floating">
                          <input type="text" class="form-control" id="requiredEquipment" placeholder="List required equipment">
                          <label for="requiredEquipment">List Required Equipment</label>
                        </div>
                      </div>
                    </div>
                    
                    <div class="modal-footer mt-4">
                      <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-1"></i> Cancel
                      </button>
                      <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i> Save Training
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Training Script -->
          <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
          <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
          <script>
            // Training Management
            document.addEventListener('DOMContentLoaded', function() {
              // DOM Elements
              const trainingForm = document.getElementById('trainingForm');
              const trainingModal = document.getElementById('addTrainingModal');
              const trainingModalInstance = trainingModal ? new bootstrap.Modal(trainingModal) : null;
              const isCertification = document.getElementById('isCertification');
              const certificationFields = document.getElementById('certificationFields');
              const validityPeriod = document.getElementById('validityPeriod');
              const certificationIssued = document.getElementById('certificationIssued');
              const certificationExpires = document.getElementById('certificationExpires');
              const trainingsList = document.getElementById('trainingsList');
              
              // Backend removed: using localStorage for training data
              
              // Initialize data
              let trainings = [];
              let isEditMode = false;
              let currentTrainingId = null;
              let currentUser = null;
              
              // Initialize the forms
              function initTrainingForms() {
                // Initialize Toolbox Talk form
                const toolboxTalkForm = document.getElementById('toolboxTalkForm');
                if (toolboxTalkForm) {
                  // Set default date and time
                  const now = new Date();
                  const today = now.toISOString().split('T')[0];
                  const time = now.toTimeString().substring(0, 5);
                  
                  if (!document.getElementById('talkDate').value) {
                    document.getElementById('talkDate').value = today;
                    document.getElementById('talkTime').value = time;
                  }
                  
                  // Add form submission handler
                  toolboxTalkForm.addEventListener('submit', handleToolboxTalkSubmit);
                }
                
                // Add refresh button handler for Toolbox Talks
                const refreshToolboxTalksBtn = document.getElementById('refreshToolboxTalks');
                if (refreshToolboxTalksBtn) {
                  refreshToolboxTalksBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    const icon = this.querySelector('i');
                    const originalIcon = icon.className;
                    
                    try {
                      // Show loading spinner
                      icon.className = 'bi-arrow-clockwise spin';
                      
                      // Reload the toolbox talks
                      await loadToolboxTalks();
                      showNotification('Toolbox Talks list refreshed', 'success');
                    } catch (error) {
                      console.error('Error refreshing Toolbox Talks:', error);
                      showNotification('Failed to refresh Toolbox Talks', 'error');
                    } finally {
                      // Restore the original icon
                      icon.className = originalIcon;
                    }
                  });
                }
                
                // Initialize Environmental Training form
                const envTrainingForm = document.getElementById('environmentalTrainingForm');
                if (envTrainingForm) {
                  // Set default date and time
                  const now = new Date();
                  const today = now.toISOString().split('T')[0];
                  const time = now.toTimeString().substring(0, 5);
                  
                  if (!document.getElementById('trainingDate').value) {
                    document.getElementById('trainingDate').value = today;
                    document.getElementById('trainingTime').value = time;
                  }
                  
                  // Toggle certification fields
                  const isCertification = document.getElementById('providesCertification');
                  const certificationFields = document.getElementById('certificationFields');
                  
                  if (isCertification && certificationFields) {
                    isCertification.addEventListener('change', function() {
                      certificationFields.style.display = this.checked ? 'block' : 'none';
                    });
                    
                    // Set initial state
                    certificationFields.style.display = isCertification.checked ? 'block' : 'none';
                  }
                  
                  // Update expiry date when issued date or validity period changes
                  const certificationIssued = document.getElementById('certificationIssued');
                  const validityPeriod = document.getElementById('validityPeriod');
                  const certificationExpires = document.getElementById('certificationExpires');
                  
                  if (certificationIssued && validityPeriod) {
                    const updateExpiryDate = () => {
                      if (certificationIssued.value && validityPeriod.value) {
                        const issuedDate = new Date(certificationIssued.value);
                        const months = parseInt(validityPeriod.value) || 0;
                        const expiryDate = new Date(issuedDate);
                        expiryDate.setMonth(expiryDate.getMonth() + months);
                        certificationExpires.value = expiryDate.toISOString().split('T')[0];
                      }
                    };
                    
                    certificationIssued.addEventListener('change', updateExpiryDate);
                    validityPeriod.addEventListener('change', updateExpiryDate);
                  }
                  
                  // Render Environmental Focus Areas checkboxes
                  const focusAreas = [
                    'Waste Management',
                    'Water Conservation',
                    'Energy Efficiency',
                    'Emissions Control',
                    'Spill Prevention',
                    'Noise Control',
                    'Biodiversity Protection',
                    'Regulatory Compliance'
                  ];
                  const focusAreasContainer = document.getElementById('focusAreasContainer');
                  if (focusAreasContainer) {
                    focusAreasContainer.innerHTML = '';
                    focusAreas.forEach((area, idx) => {
                      const col = document.createElement('div');
                      col.className = 'col-md-4';
                      col.innerHTML = `
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" name="focusArea" id="focusArea_${idx}" value="${area}">
                          <label class="form-check-label" for="focusArea_${idx}">${area}</label>
                        </div>
                      `;
                      focusAreasContainer.appendChild(col);
                    });
                  }

                  // Participants: add/remove rows
                  const addBtn = document.getElementById('addParticipantBtn');
                  const nameInput = document.getElementById('participantName');
                  const deptInput = document.getElementById('participantDept');
                  const idInput = document.getElementById('participantId');
                  const listBody = document.getElementById('participantsList');
                  if (addBtn && nameInput && deptInput && idInput && listBody) {
                    addBtn.addEventListener('click', () => {
                      const name = (nameInput.value || '').trim();
                      const dept = (deptInput.value || '').trim();
                      const empId = (idInput.value || '').trim();
                      if (!name) {
                        showNotification('Enter participant name', 'warning');
                        return;
                      }
                      const tr = document.createElement('tr');
                      tr.innerHTML = `
                        <td>${name}</td>
                        <td>${dept}</td>
                        <td>${empId}</td>
                        <td>
                          <button type="button" class="btn btn-sm btn-outline-danger remove-participant">
                            <i class="bi bi-x"></i> Remove
                          </button>
                        </td>
                      `;
                      // Attach remove handler
                      tr.querySelector('.remove-participant').addEventListener('click', () => {
                        tr.remove();
                      });
                      listBody.appendChild(tr);
                      // Clear inputs
                      nameInput.value = '';
                      deptInput.value = '';
                      idInput.value = '';
                      nameInput.focus();
                    });
                  }

                  // Add form submission handler
                  envTrainingForm.addEventListener('submit', handleEnvironmentalTrainingSubmit);
                }
              }
              
              // Toggle certification fields based on checkbox
              function toggleCertificationFields() {
                if (isCertification.checked) {
                  certificationFields.style.display = 'block';
                } else {
                  certificationFields.style.display = 'none';
                }
              }
              
              // Update expiry date based on issued date and validity period
              function updateExpiryDate() {
                if (!certificationIssued.value || !validityPeriod.value) return;
                
                const issuedDate = new Date(certificationIssued.value);
                const months = parseInt(validityPeriod.value) || 0;
                const expiryDate = new Date(issuedDate);
                expiryDate.setMonth(expiryDate.getMonth() + months);
                
                certificationExpires.value = expiryDate.toISOString().split('T')[0];
              }
              
              // Save Toolbox Talk to Supabase
              async function saveToolboxTalk(trainingData) {
                try {
                  const { data, error } = await supabase
                    .from('toolbox_talks')
                    .insert([{
                      topic: trainingData.title,
                      date: trainingData.date,
                      time: trainingData.time,
                      duration: trainingData.duration,
                      location: trainingData.location,
                      presenter: trainingData.presenter,
                      attendees: trainingData.attendees || [],
                      key_points: trainingData.keyPoints || [],
                      discussion_notes: trainingData.discussionNotes,
                      follow_up_actions: trainingData.followUpActions,
                      created_by: (await supabase.auth.getUser()).data.user.id
                    }])
                    .select()
                    .single();

                  if (error) throw error;
                  
                  // Reload the toolbox talks list
                  await loadToolboxTalks();
                  showNotification('Toolbox Talk saved successfully!', 'success');
                  return { success: true, data };
                } catch (error) {
                  console.error('Error saving Toolbox Talk:', error);
                  throw new Error('Failed to save Toolbox Talk. Please try again.');
                }
              }
              
              // Load Toolbox Talks from Supabase
              async function loadToolboxTalks() {
                const tbody = document.getElementById('toolboxTalksList');
                if (!tbody) return;
                
                try {
                  tbody.innerHTML = `
                    <tr>
                      <td colspan="5" class="text-center py-4">
                        <div class="spinner-border spinner-border-sm" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2">Loading toolbox talks...</span>
                      </td>
                    </tr>`;
                  
                  const { data: talks, error } = await supabase
                    .from('toolbox_talks')
                    .select('*')
                    .order('date', { ascending: false });
                  
                  if (error) throw error;
                  
                  if (!talks || talks.length === 0) {
                    tbody.innerHTML = `
                      <tr>
                        <td colspan="5" class="text-center py-4 text-muted">
                          <i class="bi bi-info-circle me-2"></i>
                          No toolbox talks found. Create your first one below.
                        </td>
                      </tr>`;
                    return;
                  }
                  
                  tbody.innerHTML = talks.map(talk => `
                    <tr>
                      <td>
                        <div class="fw-semibold">${escapeHtml(talk.topic || 'Untitled')}</div>
                        <small class="text-muted">${escapeHtml(talk.category || 'General')}</small>
                      </td>
                      <td>
                        <div>${new Date(talk.date).toLocaleDateString()}</div>
                        <small class="text-muted">${talk.time || ''}</small>
                      </td>
                      <td>${escapeHtml(talk.presenter || 'N/A')}</td>
                      <td>${escapeHtml(talk.location || 'N/A')}</td>
                      <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewToolboxTalk('${talk.id}')">
                          <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary me-1" onclick="editToolboxTalk('${talk.id}')">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteToolboxTalk('${talk.id}')">
                          <i class="bi bi-trash"></i>
                        </button>
                      </td>
                    </tr>
                  `).join('');
                  
                } catch (error) {
                  console.error('Error loading toolbox talks:', error);
                  tbody.innerHTML = `
                    <tr>
                      <td colspan="5" class="text-center py-4 text-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Failed to load toolbox talks. Please try again later.
                      </td>
                    </tr>`;
                }
              }
              
              // View Toolbox Talk details
              function viewToolboxTalk(id) {
                // Implement view functionality
                console.log('View toolbox talk:', id);
                showNotification('View functionality will be implemented soon', 'info');
              }
              
              // Edit Toolbox Talk
              function editToolboxTalk(id) {
                // Implement edit functionality
                console.log('Edit toolbox talk:', id);
                showNotification('Edit functionality will be implemented soon', 'info');
              }
              
              // Delete Toolbox Talk
              async function deleteToolboxTalk(id) {
                if (!confirm('Are you sure you want to delete this toolbox talk? This action cannot be undone.')) {
                  return;
                }
                
                try {
                  const { error } = await supabase
                    .from('toolbox_talks')
                    .delete()
                    .eq('id', id);
                  
                  if (error) throw error;
                  
                  showNotification('Toolbox talk deleted successfully', 'success');
                  loadToolboxTalks();
                } catch (error) {
                  console.error('Error deleting toolbox talk:', error);
                  showNotification('Failed to delete toolbox talk', 'error');
                }
              }
              
              // Helper function to escape HTML
              function escapeHtml(unsafe) {
                if (!unsafe) return '';
                return unsafe
                  .toString()
                  .replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;')
                  .replace(/'/g, '&#039;');
              }

              // Save Environmental Training to Supabase
async function saveEnvironmentalTraining(trainingData) {
  try {
    const newItem = {
      id: currentTrainingId || `${Date.now()}-${Math.random().toString(36).slice(2,8)}`,
      ...trainingData,
      createdBy: (currentUser && (currentUser.id || currentUser.email)) || 'local',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      status: 'scheduled',
      type: 'environmental-training'
    };
    const { error } = await supabase
      .from('trainings')
      .insert([ newItem ]);
    if (error) throw error;
    currentTrainingId = newItem.id;
    await loadTrainings();
    showNotification('Environmental Training saved successfully!', 'success');
    return true;
  } catch (error) {
    console.error('Error saving Environmental Training:', error);
    throw new Error('Failed to save Environmental Training. Please try again.');
  }
}

              // Handle Toolbox Talk form submission
              async function handleToolboxTalkSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const submitButton = form.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                
                try {
                  // Show loading state
                  submitButton.disabled = true;
                  submitButton.innerHTML = `
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    Saving...
                  `;
                  
                  // Get form values
                  const trainingData = {
                    title: document.getElementById('talkTopic')?.value.trim() || 'Untitled Toolbox Talk',
                    date: document.getElementById('talkDate')?.value || new Date().toISOString().split('T')[0],
                    time: document.getElementById('talkTime')?.value || '09:00',
                    duration: parseInt(document.getElementById('talkDuration')?.value) || 60,
                    location: document.getElementById('talkLocation')?.value || 'Not specified',
                    presenter: document.getElementById('talkPresenter')?.value.trim() || 'Not specified',
                    attendees: (document.getElementById('talkAttendees')?.value || '').split(',').map(s => s.trim()).filter(Boolean),
                    keyPoints: (document.getElementById('talkObjectives')?.value || '').split('\n').map(s => s.trim()).filter(Boolean),
                    discussionNotes: document.getElementById('talkContent')?.value.trim() || '',
                    followUpActions: document.getElementById('safetyConsiderations')?.value.trim() || ''
                  };
                  
                  // Validate required fields
                  const requiredFields = ['title', 'date', 'time', 'location', 'presenter'];
                  const missingFields = requiredFields.filter(field => !trainingData[field]);
                  
                  if (missingFields.length > 0) {
                    throw new Error('Please fill in all required fields: ' + missingFields.join(', '));
                  }
                  
                  // Save to Supabase
                  await saveToolboxTalk(trainingData);
                  
                  // Reload the toolbox talks list
                  await loadToolboxTalks();
                  
                  // Close the modal
                  const modal = bootstrap.Modal.getInstance(document.getElementById('addToolboxTalkModal'));
                  if (modal) modal.hide();
                  
                  // Reset form
                  form.reset();
                  showNotification('Toolbox Talk saved successfully!', 'success');
                } catch (error) {
                  console.error('Error saving Toolbox Talk:', error);
                  showNotification(error.message || 'Failed to save Toolbox Talk. Please try again.', 'error');
                } finally {
                  // Reset button state
                  submitButton.disabled = false;
                  submitButton.innerHTML = originalButtonText;
                }
              }

              // Handle Environmental Training form submission
              async function handleEnvironmentalTrainingSubmit(e) {
                e.preventDefault();
                
                try {
                  // Get form values
                  const trainingData = {
                    title: document.getElementById('trainingTitle').value.trim(),
                    type: document.getElementById('trainingType').value,
                    date: document.getElementById('trainingDate').value,
                    time: document.getElementById('trainingTime').value,
                    duration: parseInt(document.getElementById('trainingDuration').value) || 60,
                    location: document.getElementById('trainingLocation').value,
                    provider: document.getElementById('trainingProvider').value.trim(),
                    instructor: document.getElementById('trainingInstructor').value.trim(),
                    description: document.getElementById('trainingDescription').value.trim(),
                    
                    // Get selected focus areas
                    focusAreas: Array.from(document.querySelectorAll('input[name="focusArea"]:checked'))
                      .map(checkbox => checkbox.value),
                      
                    // Get participants data
                    participants: Array.from(document.querySelectorAll('#participantsList tr')).map(tr => {
                      const cells = tr.querySelectorAll('td');
                      return {
                        name: cells[0]?.textContent?.trim() || '',
                        department: cells[1]?.textContent?.trim() || '',
                        employeeId: cells[2]?.textContent?.trim() || ''
                      };
                    }),
                    
                    // Get assessment data
                    hasAssessment: document.getElementById('hasAssessment').checked,
                    passingScore: document.getElementById('passingScore').value || 0,
                    
                    // Get certification data
                    providesCertification: document.getElementById('providesCertification').checked,
                    certificationIssued: document.getElementById('certificationIssued').value,
                    validityPeriod: document.getElementById('validityPeriod').value,
                    certificationExpires: document.getElementById('certificationExpires').value,
                    
                    // Get follow-up data
                    followUpRequired: document.getElementById('followUpRequired').checked,
                    followUpDate: document.getElementById('followUpDate').value,
                    followUpNotes: document.getElementById('followUpNotes').value,
                    
                    // Additional notes
                    additionalNotes: document.getElementById('additionalNotes').value.trim()
                  };
                  
                  // Validate required fields
                  const requiredFields = [
                    'title', 'type', 'date', 'time', 'location', 'provider', 'instructor', 'description'
                  ];
                  
                  if (trainingData.providesCertification) {
                    requiredFields.push('certificationIssued', 'validityPeriod', 'certificationExpires');
                  }
                  
                  const missingFields = requiredFields.filter(field => !trainingData[field]);
                  
                  if (missingFields.length > 0) {
                    throw new Error('Please fill in all required fields');
                  }
                  
                  // Validate date/time is not in the past
                  const envWhen = new Date(`${trainingData.date}T${trainingData.time}`);
                  if (isNaN(envWhen.getTime()) || envWhen < new Date()) {
                    throw new Error('Training date and time must be in the future');
                  }
                  
                  // Refresh list/statistics
                  await saveEnvironmentalTraining(trainingData);
                  await loadTrainings();
                  await updateTrainingStats();
                  
                  // Reset only this form
                  const envForm = document.getElementById('environmentalTrainingForm');
                  envForm && envForm.reset();
                  
                  // Success and switch to Trainings Done tab
                  showNotification('Environmental Training saved successfully!', 'success');
                  const trainingsDoneTab = new bootstrap.Tab(document.getElementById('trainings-done-tab'));
                  trainingsDoneTab.show();
                  
                } catch (error) {
                  console.error('Error saving Environmental Training:', error);
                  showNotification(error.message || 'An error occurred while saving the Environmental Training.', 'error');
                }
              }
              
              // Reset form
              function resetForm() {
                trainingForm.reset();
                isEditMode = false;
                currentTrainingId = null;
                document.getElementById('addTrainingModalLabel').textContent = 'Add New Training';
                document.querySelector('#trainingForm button[type="submit"]').innerHTML = 
                  '<i class="bi bi-check-lg me-1"></i> Save Training';
              }
              
              // Render trainings list with search and filter
              function renderTrainingsList() {
                if (!trainingsList) return;
                
                // Show loading state if no data yet
                if (trainings.length === 0) {
                  trainingsList.innerHTML = `
                    <tr>
                      <td colspan="6" class="text-center py-4">
                        <p class="text-muted mb-0">No trainings found. Add a new training to get started.</p>
                      </td>
                    </tr>`;
                  return;
                }
                
                // Get search and filter values
                const searchTerm = document.getElementById('trainingSearch')?.value.toLowerCase() || '';
                const filterType = document.getElementById('trainingFilterType')?.value || 'all';
                const filterStatus = document.getElementById('trainingFilterStatus')?.value || 'all';
                
                // Filter trainings
                let filteredTrainings = trainings.filter(training => {
                  // Search in title, presenter, and location
                  const matchesSearch = searchTerm === '' || 
                    (training.title && training.title.toLowerCase().includes(searchTerm)) ||
                    (training.presenter && training.presenter.toLowerCase().includes(searchTerm)) ||
                    (training.location && training.location.toLowerCase().includes(searchTerm));
                  
                  // Filter by type
                  const matchesType = filterType === 'all' || 
                    (filterType === 'toolbox' && training.type === 'toolbox-talk') ||
                    (filterType === 'environmental' && training.type === 'environmental-training');
                  
                  // Filter by status
                  const matchesStatus = filterStatus === 'all' || 
                    (training.status && training.status.toLowerCase() === filterStatus.toLowerCase());
                  
                  return matchesSearch && matchesType && matchesStatus;
                });
                
                // Show no results message if no matches
                if (filteredTrainings.length === 0) {
                  trainingsList.innerHTML = `
                    <tr>
                      <td colspan="6" class="text-center py-4">
                        <i class="bi bi-search d-block fs-1 text-muted mb-3"></i>
                        <h5 class="text-muted">No trainings found</h5>
                        <p class="text-muted mb-0">Try adjusting your search or filter criteria</p>
                      </td>
                    </tr>`;
                  
                  // Update results count
                  const resultsCount = document.getElementById('trainingResultsCount');
                  if (resultsCount) {
                    resultsCount.textContent = '0';
                  }
                  return;
                }
                
                // Render trainings list
                trainingsList.innerHTML = '';
                filteredTrainings.forEach(training => {
                  const row = document.createElement('tr');
                  row.innerHTML = `
                    <td>${training.title}</td>
                    <td>${training.presenter}</td>
                    <td>${training.location}</td>
                    <td>${training.date} ${training.time}</td>
                    <td>${training.status}</td>
                    <td>
                      <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editTrainingModal" data-id="${training.id}">
                        <i class="bi bi-pencil me-1"></i>Edit
                      </button>
                      <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteTrainingModal" data-id="${training.id}">
                        <i class="bi bi-trash me-1"></i>Delete
                      </button>
                    </td>
                  `;
                  trainingsList.appendChild(row);
                });
                
                // Update results count
                const resultsCount = document.getElementById('trainingResultsCount');
                if (resultsCount) {
                  resultsCount.textContent = filteredTrainings.length;
                }
              }
              
              // Delete training (Supabase)
              async function deleteTraining(id) {
                if (!confirm('Are you sure you want to delete this training?')) return;
                try {
                  const { error } = await supabase
                    .from('trainings')
                    .delete()
                    .eq('id', id);
                  
                  if (error) throw error;
                  await loadTrainings();
                  showNotification('Training deleted successfully!', 'success');
                } catch (err) {
                  console.error('Delete training failed:', err);
                  showNotification('Failed to delete training: ' + err.message, 'danger');
                }
              }
              
              // Show notification
              function showNotification(message, type = 'info') {
                // Check if toast container exists, if not create it
                let toastContainer = document.getElementById('toastContainer');
                if (!toastContainer) {
                  toastContainer = document.createElement('div');
                  toastContainer.id = 'toastContainer';
                  toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
                  toastContainer.style.zIndex = '11';
                  document.body.appendChild(toastContainer);
                }
                
                // Create toast element
                const toastId = 'toast-' + Date.now();
                const toast = document.createElement('div');
                toast.id = toastId;
                toast.className = `toast align-items-center text-white bg-${type} border-0`;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', 'assertive');
                toast.setAttribute('aria-atomic', 'true');
                
                toast.innerHTML = `
                  <div class="d-flex">
                    <div class="toast-body">
                      ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                  </div>`;
                
                // Add toast to container
                toastContainer.insertBefore(toast, toastContainer.firstChild);
                
                // Initialize and show toast
                const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: 3000 });
                bsToast.show();
                
                // Remove toast after it's hidden
                toast.addEventListener('hidden.bs.toast', function() {
                  toast.remove();
                });
              }
              
              // Load trainings from Supabase
              async function loadTrainings() {
                try {
                  // Show loading state
                  if (trainingsList) {
                    trainingsList.innerHTML = `
                      <tr>
                        <td colspan="6" class="text-center py-4">
                          <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                          </div>
                          <p class="mt-2 mb-0">Loading trainings...</p>
                        </td>
                      </tr>`;
                  }
                  // Read from Supabase
                  const { data, error } = await supabase
                    .from('trainings')
                    .select('*')
                    .order('date', { ascending: false })
                    .order('created_at', { ascending: false });
                  if (error) throw error;
                  trainings = Array.isArray(data) ? data : [];
                  
                  // Render the list
                  renderTrainingsList();
                  
                } catch (error) {
                  console.error('Error loading trainings:', error);
                  showNotification(error.message || 'Failed to load trainings. Please try again.', 'error');
                  
                  if (trainingsList) {
                    trainingsList.innerHTML = `
                      <tr>
                        <td colspan="6" class="text-center py-4 text-danger">
                          <i class="bi bi-exclamation-triangle-fill d-block fs-1 mb-2"></i>
                          <p class="mb-0">Failed to load trainings. Please refresh the page to try again.</p>
                        </td>
                      </tr>`;
                  }
                }
              }
              
              // Initialize the training management system
              function initTrainingManagement() {
                // Initialize forms
                initTrainingForms();
                
                // Load trainings immediately (no auth)
                loadTrainings();

                // Set up search and filter event listeners
                const searchInput = document.getElementById('trainingSearch');
                const filterType = document.getElementById('trainingFilterType');
                const filterStatus = document.getElementById('trainingFilterStatus');
                
                if (searchInput) {
                  searchInput.addEventListener('input', renderTrainingsList);
                }
                
                if (filterType) {
                  filterType.addEventListener('change', renderTrainingsList);
                }
                
                if (filterStatus) {
                  filterStatus.addEventListener('change', renderTrainingsList);
                }
                
                // Set up export button
                const exportBtn = document.getElementById('exportTrainingsBtn');
                if (exportBtn) {
                  exportBtn.addEventListener('click', exportTrainings);
                }
              }
              
              // Export function for the export button
              function exportTrainings() {
                try {
                  if (trainings.length === 0) {
                    showNotification('No trainings to export', 'warning');
                    return;
                  }
                  
                  // Create CSV content
                  let csvContent = 'Type,Title,Date,Presenter,Location,Status,Duration (min)\n';
                  
                  trainings.forEach(training => {
                    const type = training.type === 'toolbox-talk' ? 'Toolbox Talk' : 'Environmental Training';
                    const title = `"${(training.title || '').replace(/"/g, '""')}"`;
                    const date = training.date ? new Date(training.date).toLocaleDateString() : 'N/A';
                    const presenter = `"${(training.presenter || training.instructor || '').replace(/"/g, '""')}"`;
                    const location = `"${(training.location || '').replace(/"/g, '""')}"`;
                    const status = training.status || 'scheduled';
                    const duration = training.duration || 'N/A';
                    
                    csvContent += `${type},${title},${date},${presenter},${location},${status},${duration}\n`;
                  });
                  
                  // Create download link
                  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                  const url = URL.createObjectURL(blob);
                  const link = document.createElement('a');
                  link.setAttribute('href', url);
                  link.setAttribute('download', `trainings_export_${new Date().toISOString().split('T')[0]}.csv`);
                  link.style.visibility = 'hidden';
                  
                  // Trigger download
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);
                  
                  showNotification('Export completed successfully!', 'success');
                } catch (error) {
                  console.error('Error exporting trainings:', error);
                  showNotification('Failed to export trainings. Please try again.', 'error');
                }
              }
              
              // Initialize the training management system when the DOM is fully loaded
              if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                  initTrainingManagement();
                });
              } else {
                // If the document is already loaded, initialize immediately
                initTrainingManagement();
              }
          
          </script>
          <script>
            // Global handler for adding participants (Environmental form)
            function addParticipant() {
              try {
                const nameInput = document.getElementById('participantName');
                const deptInput = document.getElementById('participantDept');
                const idInput = document.getElementById('participantId');
                const listBody = document.getElementById('participantsList');
                if (!nameInput || !deptInput || !idInput || !listBody) return;
                const name = (nameInput.value || '').trim();
                const dept = (deptInput.value || '').trim();
                const empId = (idInput.value || '').trim();
                if (!name) {
                  showNotification && showNotification('Enter participant name', 'warning');
                  return;
                }
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td>${name}</td>
                  <td>${dept}</td>
                  <td>${empId}</td>
                  <td>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-participant">
                      <i class="bi bi-x"></i> Remove
                    </button>
                  </td>
                `;
                tr.querySelector('.remove-participant').addEventListener('click', () => tr.remove());
                listBody.appendChild(tr);
                nameInput.value = '';
                deptInput.value = '';
                idInput.value = '';
                nameInput.focus();
              } catch (e) {
                console.error('addParticipant error:', e);
              }
            }
            // Dynamic Environmental Focus Areas renderer
            const DEFAULT_FOCUS_AREAS = [
              { id: 'focusWaste', label: 'Waste Management', value: 'Waste Management', icon: 'bi-trash3' },
              { id: 'focusPollution', label: 'Pollution Prevention', value: 'Pollution Prevention', icon: 'bi-cloud-fog2' },
              { id: 'focusEnergy', label: 'Energy Conservation', value: 'Energy Conservation', icon: 'bi-lightning-charge' },
              { id: 'focusWater', label: 'Water Conservation', value: 'Water Conservation', icon: 'bi-droplet' },
              { id: 'focusBiodiversity', label: 'Biodiversity Protection', value: 'Biodiversity Protection', icon: 'bi-tree' },
              { id: 'focusRegulatory', label: 'Regulatory Compliance', value: 'Regulatory Compliance', icon: 'bi-file-earmark-text' }
            ];
            function renderFocusAreas(areas = DEFAULT_FOCUS_AREAS) {
              const container = document.getElementById('focusAreasContainer');
              if (!container) return;
              container.innerHTML = '';
              areas.forEach(a => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4';
                col.innerHTML = `
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="focusArea" id="${a.id}" value="${a.value}">
                    <label class="form-check-label" for="${a.id}">
                      <i class="bi ${a.icon} me-1"></i>${a.label}
                    </label>
                  </div>`;
                container.appendChild(col);
              });
            }
          </script>
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              // Ensure focus areas are rendered
              const fac = document.getElementById('focusAreasContainer');
              if (fac && fac.children.length === 0) {
                renderFocusAreas();
              }
              // trainings will be loaded from Supabase via loadTrainings() in initTrainingManagement
              
              // Save trainings to Supabase (bulk upsert fallback)
              async function saveTrainings() {
                try {
                  if (!Array.isArray(trainings)) return true;
                  const { error } = await supabase.from('trainings').upsert(trainings);
                  if (error) throw error;
                  renderTrainingLists();
                  initCalendar();
                  return true;
                } catch (error) {
                  console.error('Error saving trainings:', error);
                  showNotification('Failed to save training data. Please try again.', 'error');
                  return false;
                }
              }
              
              // Initialize calendar
              function initCalendar() {
                const calendarEl = document.getElementById('trainingCalendar');
                if (!calendarEl) return;
                
                const calendar = new FullCalendar.Calendar(calendarEl, {
                  initialView: 'dayGridMonth',
                  headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                  },
                  events: trainings.map(training => ({
                    title: training.title,
                    start: `${training.date}T${training.time}`,
                    allDay: false,
                    backgroundColor: training.isCertification ? '#28a745' : '#007bff',
                    borderColor: training.isCertification ? '#218838' : '#0069d9',
                    extendedProps: {
                      instructor: training.instructor,
                      description: training.description,
                      isCertification: training.isCertification
                    }
                  })),
                  eventClick: function(info) {
                    const event = info.event;
                    const isCert = event.extendedProps.isCertification;
                    
                    // Create modal content
                    const modalContent = `
                      <div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title">${event.title}</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                              <p><strong>Date:</strong> ${event.start.toLocaleDateString()}</p>
                              <p><strong>Time:</strong> ${event.start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                              <p><strong>Instructor:</strong> ${event.extendedProps.instructor}</p>
                              <p><strong>Description:</strong> ${event.extendedProps.description || 'No description provided.'}</p>
                              ${isCert ? `<p><strong>Type:</strong> Certification</p>` : ''}
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    `;
                    
                    // Add modal to DOM and show it
                    document.body.insertAdjacentHTML('beforeend', modalContent);
                    const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
                    eventModal.show();
                    
                    // Clean up modal after it's closed
                    document.getElementById('eventModal').addEventListener('hidden.bs.modal', function() {
                      document.getElementById('eventModal').remove();
                    });
                  }
                });
                
                calendar.render();
              }
              
              // Render training lists
              function renderTrainingLists() {
                const upcomingList = document.getElementById('upcomingTrainings');
                const certificationsList = document.getElementById('myCertifications');
                
                if (!upcomingList || !certificationsList) return;
                
                try {
                  // Clear existing content with fade out effect
                  upcomingList.style.opacity = '0.5';
                  certificationsList.style.opacity = '0.5';
                  
                  setTimeout(() => {
                    upcomingList.innerHTML = '';
                    certificationsList.innerHTML = '';
                    
                    // Sort trainings by date (ascending)
                    const sortedTrainings = [...trainings].sort((a, b) => {
                      return new Date(a.datetime || a.date + 'T' + (a.time || '00:00')) - 
                             new Date(b.datetime || b.date + 'T' + (b.time || '00:00'));
                    });
                    
                    // Get current date for filtering
                    const now = new Date();
                    
                    // Separate upcoming trainings and certifications
                    const upcoming = [];
                    const certifications = [];
                    
                    sortedTrainings.forEach(training => {
                      const trainingDate = training.datetime ? 
                        new Date(training.datetime) : 
                        new Date(training.date + 'T' + (training.time || '23:59'));
                      
                      if (training.isCertification || training.certification) {
                        certifications.push(training);
                      }
                      
                      if (trainingDate >= now) {
                        upcoming.push(training);
                      }
                    });
                    
                    // Render upcoming trainings
                    if (upcoming.length > 0) {
                      upcoming.forEach(training => {
                        const item = document.createElement('div');
                        item.className = 'list-group-item mb-2 rounded-3';
                        item.style.transition = 'all 0.3s ease';
                        item.style.borderLeft = '4px solid #0d6efd';
                        
                        const trainingDate = training.datetime ? 
                          new Date(training.datetime) : 
                          new Date(training.date + 'T' + (training.time || '00:00'));
                        
                        item.innerHTML = `
                          <div class="d-flex w-100 justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 fw-bold">${training.title}</h6>
                            <span class="badge bg-${training.status === 'completed' ? 'success' : 'primary'} text-white">
                              ${training.status || 'scheduled'}
                            </span>
                          </div>
                          <div class="d-flex w-100 justify-content-between mb-2">
                            <small class="text-muted">
                              <i class="bi bi-calendar-event me-1"></i>
                              ${trainingDate.toLocaleDateString()}
                              <i class="bi bi-clock ms-2 me-1"></i>
                              ${trainingDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            </small>
                            <small class="text-muted">
                              <i class="bi bi-person me-1"></i>
                              ${training.instructor || 'Not specified'}
                            </small>
                          </div>
                          ${training.description ? `<p class="mb-2">${training.description}</p>` : ''}
                          ${training.isCertification ? 
                            '<span class="badge bg-info text-dark"><i class="bi bi-award me-1"></i>Certification</span>' : ''}
                        `;
                        
                        // Add hover effect
                        item.addEventListener('mouseenter', () => {
                          item.style.transform = 'translateX(5px)';
                          item.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                        });
                        
                        item.addEventListener('mouseleave', () => {
                          item.style.transform = 'translateX(0)';
                          item.style.boxShadow = 'none';
                        });
                        
                        upcomingList.appendChild(item);
                      });
                    } else {
                      upcomingList.innerHTML = `
                        <div class="text-center py-4">
                          <i class="bi bi-calendar-x text-muted" style="font-size: 2rem;"></i>
                          <p class="mt-2 mb-0 text-muted">No upcoming trainings scheduled</p>
                        </div>
                      `;
                    }
                    
                    // Render certifications
                    if (certifications.length > 0) {
                      certifications.forEach(cert => {
                        const certData = cert.certification || cert;
                        const item = document.createElement('div');
                        item.className = 'list-group-item mb-2 rounded-3';
                        item.style.transition = 'all 0.3s ease';
                        
                        const issuedDate = certData.issuedDate ? new Date(certData.issuedDate) : null;
                        const expiryDate = certData.expiryDate ? new Date(certData.expiryDate) : null;
                        const isExpired = expiryDate && expiryDate < now;
                        const daysToExpire = expiryDate ? 
                          Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24)) : null;
                        
                        // Set border color based on expiration status
                        if (isExpired) {
                          item.style.borderLeft = '4px solid #dc3545';
                        } else if (daysToExpire <= 30) {
                          item.style.borderLeft = '4px solid #ffc107';
                        } else {
                          item.style.borderLeft = '4px solid #198754';
                        }
                        
                        item.innerHTML = `
                          <div class="d-flex w-100 justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 fw-bold">${cert.title || 'Untitled Certification'}</h6>
                            <span class="badge bg-${isExpired ? 'danger' : 'success'} text-white">
                              ${isExpired ? 'Expired' : 'Valid'}
                            </span>
                          </div>
                          
                          <div class="d-flex flex-wrap justify-content-between mb-2">
                            <div class="me-3">
                              <small class="text-muted d-block">
                                <i class="bi bi-building me-1"></i>
                                ${certData.issuingOrg || 'Not specified'}
                              </small>
                              <small class="text-muted">
                                <i class="bi bi-card-text me-1"></i>
                                ${certData.certificateNumber || 'N/A'}
                              </small>
                            </div>
                            
                            <div class="text-end">
                              ${issuedDate ? `
                                <small class="text-muted d-block">
                                  <i class="bi bi-calendar-check me-1"></i>
                                  Issued: ${issuedDate.toLocaleDateString()}
                                </small>
                              ` : ''}
                              
                              ${expiryDate ? `
                                <small class="${isExpired ? 'text-danger' : 'text-muted'} d-block">
                                  <i class="bi bi-calendar-x me-1"></i>
                                  ${isExpired ? 'Expired' : 'Expires'}: ${expiryDate.toLocaleDateString()}
                                  ${!isExpired && daysToExpire <= 30 ? 
                                    `(${daysToExpire} ${daysToExpire === 1 ? 'day' : 'days'} left)` : ''}
                                </small>
                              ` : ''}
                            </div>
                          </div>
                          
                          ${cert.description ? `<p class="mb-2">${cert.description}</p>` : ''}
                          
                          <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                              <i class="bi bi-person me-1"></i>
                              ${cert.instructor || 'Instructor not specified'}
                            </small>
                            <button class="btn btn-sm btn-outline-primary">
                              <i class="bi bi-download me-1"></i>Certificate
                            </button>
                          </div>
                        `;
                        
                        // Add hover effect
                        item.addEventListener('mouseenter', () => {
                          item.style.transform = 'translateX(5px)';
                          item.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                        });
                        
                        item.addEventListener('mouseleave', () => {
                          item.style.transform = 'translateX(0)';
                          item.style.boxShadow = 'none';
                        });
                        
                        certificationsList.appendChild(item);
                      });
                    } else {
                      certificationsList.innerHTML = `
                        <div class="text-center py-4">
                          <i class="bi bi-award text-muted" style="font-size: 2rem;"></i>
                          <p class="mt-2 mb-0 text-muted">No certifications found</p>
                          <button class="btn btn-sm btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addTrainingModal">
                            <i class="bi bi-plus-lg me-1"></i>Add Certification
                          </button>
                        </div>
                      `;
                    }
                    
                    // Restore opacity
                    upcomingList.style.opacity = '1';
                    certificationsList.style.opacity = '1';
                    
                  }, 100);
                  
                } catch (error) {
                  console.error('Error rendering training lists:', error);
                  upcomingList.innerHTML = '<div class="alert alert-danger">Error loading trainings. Please refresh the page.</div>';
                  certificationsList.innerHTML = '<div class="alert alert-danger">Error loading certifications. Please refresh the page.</div>';
                }    
              }
              
              // Toggle certification fields
              const isCertificationCheckbox = document.getElementById('isCertification');
              if (isCertificationCheckbox) {
                isCertificationCheckbox.addEventListener('change', function() {
                  const certFields = document.getElementById('certificationFields');
                  if (certFields) {
                    certFields.style.display = this.checked ? 'block' : 'none';
                  }
                });
              }

              // Initialize form with current date and time
              function initializeForm() {
                const today = new Date();
                const nextHour = new Date(today.getTime() + 60 * 60 * 1000); // Default to next hour
                const timeString = nextHour.toTimeString().substring(0, 5);
                const dateInput = document.getElementById('trainingDate');
                const timeInput = document.getElementById('trainingTime');
                const issuedDateInput = document.getElementById('certificationIssued');
                const expiryDateInput = document.getElementById('certificationExpires');
                const validityPeriod = document.getElementById('validityPeriod');
                
                // Set minimum date to today
                if (dateInput) {
                  dateInput.min = today.toISOString().split('T')[0];
                  dateInput.value = nextHour.toISOString().split('T')[0];
                }
                
                // Set default time to next hour
                if (timeInput) {
                  timeInput.value = timeString;
                }
                
                // Set certification dates
                if (issuedDateInput) {
                  issuedDateInput.max = today.toISOString().split('T')[0];
                  issuedDateInput.value = today.toISOString().split('T')[0];
                }
                
                // Set default expiry date (1 year from now)
                if (expiryDateInput) {
                  const nextYear = new Date();
                  nextYear.setFullYear(today.getFullYear() + 1);
                  expiryDateInput.min = today.toISOString().split('T')[0];
                  expiryDateInput.value = nextYear.toISOString().split('T')[0];
                }
                
                // Update expiry date when validity period changes
                if (validityPeriod && issuedDateInput && expiryDateInput) {
                  const updateExpiryDate = () => {
                    const issuedDate = new Date(issuedDateInput.value);
                    const months = parseInt(validityPeriod.value) || 0;
                    const expiryDate = new Date(issuedDate);
                    expiryDate.setMonth(expiryDate.getMonth() + months);
                    expiryDateInput.value = expiryDate.toISOString().split('T')[0];
                  };
                  
                  validityPeriod.addEventListener('change', updateExpiryDate);
                  issuedDateInput.addEventListener('change', updateExpiryDate);
                }
              }
              
              // Initialize form when modal is shown
              const addTrainingModal = document.getElementById('addTrainingModal');
              if (addTrainingModal) {
                addTrainingModal.addEventListener('show.bs.modal', initializeForm);
                
                // Reset form when modal is hidden
                addTrainingModal.addEventListener('hidden.bs.modal', function() {
                  const form = document.getElementById('addTrainingForm');
                  if (form) form.reset();
                  const certFields = document.getElementById('certificationFields');
                  if (certFields) certFields.style.display = 'none';
                });
              }

              // Handle form submission
              const addTrainingForm = document.getElementById('addTrainingForm');
              if (addTrainingForm) {
                addTrainingForm.addEventListener('submit', async function(e) {
                  e.preventDefault();
                  
                  // Get form elements
                  const form = e.target;
                  const submitBtn = form.querySelector('button[type="submit"]');
                  const originalBtnText = submitBtn.innerHTML;
                  
                  try {
                    // Show loading state
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
                    
                    const isCertification = document.getElementById('isCertification').checked;
                    
                    // Validate required fields
                    const title = document.getElementById('trainingTitle').value.trim();
                    const date = document.getElementById('trainingDate').value;
                    const time = document.getElementById('trainingTime').value;
                    const instructor = document.getElementById('trainingInstructor').value.trim();
                    const description = document.getElementById('trainingDescription').value.trim();
                    
                    // Basic validation
                    if (!title || !date || !time || !instructor) {
                      throw new Error('Please fill in all required fields');
                    }
                    
                    // Validate date is not in the past
                    const trainingDate = new Date(`${date}T${time}`);
                    if (trainingDate < new Date()) {
                      throw new Error('Training date and time must be in the future');
                    }
                    
                    // Prepare training data
                    const trainingData = {
                      id: Date.now().toString(),
                      title: title,
                      date: date,
                      time: time,
                      datetime: trainingDate.toISOString(),
                      instructor: instructor,
                      description: description,
                      isCertification: isCertification,
                      status: 'scheduled',
                      createdAt: new Date().toISOString(),
                      createdBy: (currentUser && (currentUser.id || currentUser.email)) || 'local'
                    };

                    // Add certification-specific fields if applicable
                    if (isCertification) {
                      const validityPeriod = parseInt(document.getElementById('validityPeriod').value) || 12;
                      const issuingOrg = document.getElementById('issuingOrg').value.trim();
                      const certificateNumber = document.getElementById('certificateNumber').value.trim() || `CERT-${Date.now()}`;
                      const issuedDate = document.getElementById('certificationIssued').value || date;
                      
                      if (!issuingOrg) {
                        throw new Error('Please enter the issuing organization for certification');
                      }
                      
                      trainingData.certification = {
                        validityPeriod: validityPeriod,
                        issuingOrg: issuingOrg,
                        certificateNumber: certificateNumber,
                        issuedDate: issuedDate,
                        expiryDate: new Date(new Date(issuedDate).setMonth(new Date(issuedDate).getMonth() + validityPeriod)).toISOString().split('T')[0]
                      };
                    }

                    // Save a single training row to Supabase then reload
                    const { error: trErr } = await supabase
                      .from('trainings')
                      .insert([ trainingData ]);
                    if (trErr) throw trErr;
                    await loadTrainings();

                    // Reset form and close modal
                    form.reset();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addTrainingModal'));
                    if (modal) modal.hide();

                    // Show success message
                    showNotification('Training added successfully!', 'success');
                    
                  } catch (error) {
                    console.error('Error adding training:', error);
                    showNotification(error.message || 'Failed to add training. Please try again.', 'error');
                  } finally {
                    // Reset button state
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                  }
                });
              }
              
              // Initialize the UI
              renderTrainingLists();
              initCalendar();
              
              // Refresh calendar when tab is shown
              document.getElementById('trainings-tab')?.addEventListener('shown.bs.tab', function() {
                initCalendar();
              });
            });
          </script>
            
          <!-- About Me Tab -->
          <div class="tab-pane fade" id="aboutme" role="tabpanel">
            <div class="text-center mb-5">
              <div class="profile-img">
                <img src="Elius.jpg" alt="Profile Photo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
              </div>
              <h2>ELIUS D.A</h2>
              <h5 class="text-muted">Pentester</h5>
              <div class="social-links">
                <a href="https://wa.me/971552623327" class="btn btn-outline-success" target="_blank">
                  <i class="bi bi-whatsapp me-2"></i>WhatsApp
                </a>
                <a href="mailto:niwamanyaelius95@gmail.com" class="btn btn-link text-decoration-none" target="_blank">
                  <i class="bi bi-envelope me-2"></i>Email
                </a>
                <a href="https://www.linkedin.com/in/elius-niwamanya-026228187/" class="btn btn-link text-decoration-none" target="_blank">
                  <i class="bi bi-linkedin me-2"></i>LinkedIn
                </a>
              </div>
            </div>
            
            <div class="row g-4">
              <div class="col-md-6">
                <div class="card h-100">
                  <div class="card-body">
                    <h4 class="card-title mb-3"><i class="bi bi-person-lines-fill me-2"></i>Professional Profile</h4>
                    <ul class="list-group list-group-flush">
                      <li class="list-group-item d-flex align-items-center">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        Lifting Supervisor
                      </li>
                      <li class="list-group-item d-flex align-items-center">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        Penetration & Testing
                      </li>
                      <li class="list-group-item d-flex align-items-center">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        Full-Stack Developer
                      </li>
                      <li class="list-group-item d-flex align-items-center">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        Cybersecurity Enthusiast
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="card h-100">
                  <div class="card-body">
                    <h4 class="card-title mb-3"><i class="bi bi-info-circle-fill me-2"></i>Contact Information</h4>
                    <ul class="list-group list-group-flush">
                      <li class="list-group-item">
                        <i class="bi bi-telephone-fill me-2 text-primary"></i>
                        +971 55 262 3327
                      </li>
                      <li class="list-group-item">
                        <i class="bi bi-envelope-fill me-2 text-primary"></i>
                        niwamanyaelius95@gmail.com
                      </li>
                      <li class="list-group-item">
                        <i class="bi bi-geo-alt-fill me-2 text-primary"></i>
                        Dubai, UAE
                      </li>
                      
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modern Theme Toggle -->
  <div class="theme-toggle-container">
    <div class="toggle-wrapper">
      <input type="checkbox" id="themeToggle" class="toggle-input" aria-label="Toggle dark mode">
      <label for="themeToggle" class="toggle-label">
        <span class="toggle-track">
          <span class="toggle-thumb">
            <span class="toggle-icons">
              <i class="bi bi-sun-fill sun-icon"></i>
              <i class="bi bi-moon-fill moon-icon"></i>
            </span>
          </span>
        </span>
        <span class="toggle-ripple"></span>
      </label>
    </div>
  </div>

  <!-- Image Modal -->
  <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="imageModalLabel">Image Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <img id="modalImage" src="" alt="Preview" class="img-fluid" style="max-height: 70vh;">
        </div>
        <div class="modal-footer">
          <a id="downloadImage" href="#" class="btn btn-primary" download>
            <i class="bi bi-download"></i> Download
          </a>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Calendar and Date Libraries -->
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/bootstrap5@5.11.3/index.global.min.js'></script>
  <!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageModalLabel">Observation Photo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img src="" id="expandedImage" class="img-fluid" alt="Expanded Observation Photo">
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>

    async function signOut() {
      try { await supabase.auth.signOut(); } catch (_) {}
      try { localStorage.removeItem('assessorData'); } catch (_) {}
      window.currentUser = null;
      showNotification('Signed out', 'success');
      // Do not gate UI
      document.getElementById('signInForm')?.reset();
      document.getElementById('signUpForm')?.reset();
    }

    async function deleteObservation(observationId) {
      if (!observationId) {
        console.error('Delete failed: No observation ID provided.');
        return;
      }

      const confirmed = confirm('Are you sure you want to delete this observation?');

      if (confirmed) {
        try {
          const { error } = await supabase
            .from('observations')
            .delete()
            .match({ id: observationId });

          if (error) {
            throw error;
          }

          showNotification('Observation deleted successfully.', 'success');
          
          // Refresh the observations list to reflect the deletion
          await loadObservationsFromSupabase();
          renderObservations(window.allObservations);

        } catch (error) {
          console.error('Error deleting observation:', error);
          showNotification(`Error: ${error.message}`, 'danger');
        }
      }
    }

    // Initialize UI without auth gating
    document.addEventListener('DOMContentLoaded', async function() {
      await initAuth();
    });
    
    // Theme Toggle Functionality - Supabase-backed
    document.addEventListener('DOMContentLoaded', function() {
      const themeToggle = document.getElementById('themeToggle');
      if (!themeToggle) return;

      let currentTheme = 'light';
      let hasUserPreference = false;

      async function getUserId() {
        try {
          const { data: { user } } = await supabase.auth.getUser();
          return user?.id || null;
        } catch (_) { return null; }
      }

      async function loadThemePreference() {
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        try {
          const userId = await getUserId();
          if (!userId) {
            hasUserPreference = false;
            return systemPrefersDark ? 'dark' : 'light';
          }
          const { data, error } = await supabase
            .from('user_preferences')
            .select('theme')
            .eq('user_id', userId)
            .maybeSingle();
          if (error) throw error;
          if (data && data.theme) {
            hasUserPreference = true;
            return data.theme;
          }
          hasUserPreference = false;
          return systemPrefersDark ? 'dark' : 'light';
        } catch (e) {
          console.warn('Failed to load theme preference, using system preference.', e);
          hasUserPreference = false;
          return systemPrefersDark ? 'dark' : 'light';
        }
      }

      async function saveThemePreference(theme) {
        try {
          const userId = await getUserId();
          if (!userId) return; // no-op if not authenticated
          const { error } = await supabase
            .from('user_preferences')
            .upsert({ user_id: userId, theme }, { onConflict: 'user_id' });
          if (error) throw error;
          hasUserPreference = true;
        } catch (e) {
          console.error('Failed to save theme preference:', e);
        }
      }

      function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        themeToggle.checked = theme === 'dark';
        const track = document.querySelector('.track:before');
        if (track) {
          track.style.transition = 'none';
          track.style.left = theme === 'dark' ? '0%' : '-100%';
          void track.offsetWidth;
          track.style.transition = 'all 0.25s ease 0s';
        }
        const thumb = document.querySelector('.thumb');
        if (thumb) {
          thumb.style.transition = 'none';
          const sz = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--sz').trim()) || 10;
          thumb.style.left = theme === 'dark' 
            ? `calc(100% - ${sz * 2 - sz/5}px + ${sz/10}px)` 
            : `calc(${sz/10 + sz/100}px)`;
          void thumb.offsetWidth;
          thumb.style.transition = 'all 0.25s ease 0s';
        }
      }

      // Initialize theme from Supabase or system
      (async () => {
        currentTheme = await loadThemePreference();
        setTheme(currentTheme);
      })();

      // Toggle theme on switch click
      themeToggle.addEventListener('change', async (e) => {
        const newTheme = e.target.checked ? 'dark' : 'light';
        currentTheme = newTheme;
        setTheme(newTheme);
        await saveThemePreference(newTheme);
      });

      // Listen for system theme changes (only if no saved user preference)
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', async e => {
        if (!hasUserPreference) {
          const newTheme = e.matches ? 'dark' : 'light';
          currentTheme = newTheme;
          setTheme(newTheme);
        }
      });
    });

    document.addEventListener('DOMContentLoaded', function() {
      // Initialize date field with current date
      const dateField = document.getElementById('date');
      if (dateField) {
        dateField.value = new Date().toISOString().split('T')[0];
      }
      
      // DOM elements
      const inspectorSelect = document.getElementById('inspector');
      const observationsList = document.getElementById('observationsList');
      const exportBtn = document.getElementById('exportObservations');
      const authContainer = document.getElementById('authContainer');
      const assessorManagement = document.getElementById('assessorManagement');
      
      // Data storage
      let assessorData = {};
      // Observations are now fully Supabase-backed; keep local array for legacy code paths only
      let observations = [];
      
      // Chart instances
      
      // Handle Responsible Engineer dropdown change
      window.handleResponsibleChange = function() {
        const responsibleSelect = document.getElementById('responsible');
        const customInput = document.getElementById('customResponsible');
        
        if (responsibleSelect && customInput) {
          if (responsibleSelect.value === 'write_custom') {
            customInput.style.display = 'block';
            customInput.required = true;
            customInput.focus();
          } else {
            customInput.style.display = 'none';
            customInput.required = false;
            customInput.value = '';
          }
        }
      };
      
  
  // Add custom responsible engineer name
  window.addCustomResponsibleName = async function(name) {
    const trimmed = name.trim();
    if (!trimmed) return;
    
    try {
      await supabase.from('custom_responsible_names').insert({ name: trimmed });
      // Add option to dropdown (before 'Write name' option)
      const responsibleSelect = document.getElementById('responsible');
      const writeOption = responsibleSelect.querySelector('option[value="write_custom"]');
      const newOption = document.createElement('option');
      newOption.value = trimmed;
      newOption.textContent = trimmed;
      if (writeOption) {
        responsibleSelect.insertBefore(newOption, writeOption);
      } else {
        responsibleSelect.appendChild(newOption);
      }
      
      // Select the newly added option
      responsibleSelect.value = trimmed;
      const customInput = document.getElementById('customResponsible');
      customInput.value = '';
      customInput.style.display = 'none';
      customInput.previousElementSibling.textContent = 'Responsible Engineer';
      showNotification('Added custom name', 'success');
    } catch (e) {
      console.error('Failed to save custom responsible name:', e);
      showNotification('Failed to save custom name', 'danger');
    }
  };
  
  // Initialize responsible dropdown change handler
  const responsibleSelect = document.getElementById('responsible');
  if (responsibleSelect) {
    responsibleSelect.addEventListener('change', handleResponsibleChange);
  }
  
  // Observations are loaded from Supabase elsewhere via loadObservationsFromSupabase() and applyFilters()
  
  // Load saved assessor data if exists
  const savedAssessorData = localStorage.getItem('assessorData');
  if (savedAssessorData) {
    assessorData = JSON.parse(savedAssessorData);
    // Hide auth container and show assessor management
    if (authContainer) authContainer.style.display = 'none';
    if (assessorManagement) assessorManagement.style.display = 'block';
    
    // Update inspector dropdown
    if (inspectorSelect && assessorData.name) {
      inspectorSelect.innerHTML = `
        <option disabled selected value="">Select Inspector</option>
        <option selected value="${assessorData.name}">${assessorData.name}</option>
      `;
    }
  }
  
  // Note: Login form removed - using direct assessor management
  
  // Show notification to user
  function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
    notification.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 5000);
  }
      
      // Note: Assessor form uses saveAssessorInfo() function called by button onclick
      
      // HSE Form Submission (uploads photos to Supabase Storage)
      document.getElementById('hseForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        try {
          // Form validation
          const requiredFields = ['location', 'date', 'risk', 'responsible', 'inspector', 'observation'];
          for (const field of requiredFields) {
            const el = document.getElementById(field);
            if (!el || !el.value || !el.value.trim()) {
              alert(`Please fill in the ${field} field`);
              return;
            }
          }

          const photoInput = document.getElementById('photo');
          const photoFiles = Array.from(photoInput ? photoInput.files : []);
          if (photoFiles.length > 5) {
            alert('Maximum 5 photos allowed');
            return;
          }

          // Upload photos to Supabase Storage and collect public URLs
          const uploadedPhotos = [];
          for (const file of photoFiles) {
            const ts = new Date().toISOString().replace(/[:.]/g, '-');
            const rand = Math.random().toString(36).slice(2, 8);
            const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
            const path = `observations/${ts}-${rand}-${safeName}`;

            const { error: uploadError } = await supabase.storage
              .from('inspection-photos')
              .upload(path, file, { cacheControl: '3600', upsert: false });
            if (uploadError) {
              console.error('Upload failed for', file.name, uploadError);
              alert(`Failed to upload ${file.name}: ${uploadError.message}`);
              return;
            }

            const { data: pub } = supabase.storage
              .from('inspection-photos')
              .getPublicUrl(path);
            uploadedPhotos.push({
              name: file.name,
              url: pub?.publicUrl || '',
              size: (file.size / (1024 * 1024)).toFixed(2) + 'MB'
            });
          }

          // Save observation to Supabase using public photo URLs
          const locationVal = document.getElementById('location').value.trim();
          const riskVal = document.getElementById('risk').value;
          const responsibleVal = document.getElementById('responsible').value;
          const inspectorVal = document.getElementById('inspector').value;
          const observationVal = document.getElementById('observation').value.trim();
          const actionTakenVal = document.getElementById('actionTaken').value.trim();

          // Normalize risk to satisfy DB CHECK constraint ('High','Medium','Low')
          const riskLevel = (() => {
            const m = { high: 'High', medium: 'Medium', low: 'Low' };
            const v = (riskVal || '').toString().trim().toLowerCase();
            return m[v] || 'Low';
          })();

          const payload = {
            assessor_id: currentUser?.assessor_id || null,
            location: locationVal,
            observation: observationVal,
            risk_level: riskLevel,
            action_taken: actionTakenVal,
            responsible: responsibleVal,
            photos: Array.isArray(uploadedPhotos) ? uploadedPhotos : [],
          };

          const { error: insertError } = await supabase
            .from('observations')
            .insert(payload);
          if (insertError) throw insertError;

          // Reload observations from Supabase and re-apply filters
          await loadObservationsFromSupabase();
          applyFilters();

          // Reset form
          this.reset();
          document.getElementById('date').value = new Date().toISOString().split('T')[0];

          alert('Inspection report submitted successfully!');
        } catch (err) {
          console.error('Error submitting observation:', err);
          alert('Failed to submit observation. Please try again.');
        }
      });
      
      // Export Observations (from Supabase-backed data)
      exportBtn.addEventListener('click', function() {
        const list = (window.filteredObservations && window.filteredObservations.length)
          ? window.filteredObservations
          : (window.allObservations || []);
        if (list.length === 0) {
          alert('No observations to export');
          return;
        }

        // Convert to CSV
        const headers = ['ID', 'Date', 'Location', 'Risk', 'Responsible', 'Observation', 'Action Taken'];
        const csvRows = [
          headers.join(','),
          ...list.map(obs => 
            [
              obs.id,
              obs.created_at || '',
              `"${(obs.location || '').replace(/"/g, '""')}"`,
              obs.risk_level || obs.risk || '',
              `"${(obs.responsible || '').replace(/"/g, '""')}"`,
              `"${(obs.observation || '').replace(/"/g, '""')}"`,
              `"${(obs.action_taken || obs.actionTaken || '').replace(/"/g, '""')}"`
            ].join(',')
          )
        ];

        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `hse_observations_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
      
      // Legacy renderer (kept for reference) - not used by Supabase flow
      function renderObservationsLegacy() {
        console.log('Rendering observations. Total observations:', observations.length);
        if (observations.length === 0) {
          observationsList.innerHTML = `
            <div class="col-12 text-center py-5">
              <i class="bi bi-info-circle" style="font-size: 3rem; color: #6c757d;"></i>
              <h4 class="mt-3">No observations found</h4>
              <p class="text-muted">Submit your first inspection report to see it here</p>
            </div>
          `;
          
          // Update counters
          updateCounters();
          renderCharts();
          return;
        }
        
        observationsList.innerHTML = observations.map(obs => `
          <div class="col-md-6 col-lg-4">
            <div class="card observation-card h-100">
              <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                  ${obs.assessor && obs.assessor.photoURL ? `
                    <img src="${obs.assessor.photoURL}" alt="Assessor" 
                        class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;">
                  ` : '<div class="rounded-circle bg-secondary me-3" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;"><i class="bi bi-person text-white"></i></div>'}
                  <div>
                    <h5 class="card-title mb-0">${obs.inspector}</h5>
                    <small class="text-muted">${obs.assessor && obs.assessor.position ? obs.assessor.position : 'Inspector'}</small>
                  </div>
                </div>
                
                <div class="mb-3">
                  <span class="badge bg-${getRiskColor(obs.risk)} me-2">${obs.risk} Risk</span>
                  <span class="badge bg-secondary">${formatDate(obs.date)}</span>
                </div>
                
                <div class="row g-2 mb-3">
                  <div class="col-md-6">
                    <p class="card-text mb-1"><strong><i class="bi bi-geo-alt me-2"></i>Location:</strong></p>
                    <p class="text-muted ms-3">${obs.location}</p>
                  </div>
                  <div class="col-md-6">
                    <p class="card-text mb-1"><strong><i class="bi bi-person-vcard me-2"></i>Responsible Engineer:</strong></p>
                    <p class="text-muted ms-3">${obs.responsible}</p>
                  </div>
                  <div class="col-12">
                    <p class="card-text mb-1"><strong><i class="bi bi-chat-square-text me-2"></i>Observation:</strong></p>
                    <p class="text-muted ms-3">${obs.observation}</p>
                  </div>
                </div>
                
                ${obs.photos && obs.photos.length > 0 ? (() => {
                  console.log('Processing photos for observation:', { 
                    id: obs.id, 
                    photoCount: obs.photos.length,
                    photos: obs.photos 
                  });
                  return `
                  <div class="mt-3">
                    <p class="small text-muted mb-2">Attachments (${obs.photos.length})</p>
                    <div class="d-flex flex-wrap">
                      ${obs.photos.map(photo => {
                        const isImage = /.(jpg|jpeg|png|gif|webp)$/i.test(photo.name);
                        const fileName = photo.name.length > 15 ? photo.name.substring(0, 12) + '...' : photo.name;
                        
                        return `
                        <div class="img-preview-container" title="${photo.name}">
                          <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#imageModal" data-img="${photo.url}">
                            ${isImage ? 
                              `<img src="${photo.url}" alt="Preview" class="img-preview">` : 
                              `<div class="file-preview">
                                <i class="bi bi-file-earmark-text text-primary" style="font-size: 2rem;"></i>
                                <small class="text-truncate mt-1">${fileName}</small>
                              </div>`
                            }
                          </a>
                          <small class="position-absolute bottom-0 start-0 end-0 text-center bg-dark bg-opacity-75 text-white py-1">
                            ${photo.size}
                          </small>
                        </div>
                      `;}).join('')}
                    </div>
                  </div>
                `;})() : ''}
              </div>
              <div class="card-footer bg-transparent border-top d-flex justify-content-between align-items-center">
                <small class="text-muted">Reported at ${formatTime(obs.timestamp)}</small>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteObservation(${obs.id})" title="Delete observation">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `).join('');
        
        // Force reflow for animation
        document.querySelectorAll('.observation-card').forEach((card, index) => {
          setTimeout(() => {
            card.style.animationDelay = `${index * 0.1}s`;
          }, 10);
        });
        
        // Update counters and charts
        updateCounters();
        renderCharts();
      }
      
      // Update statistics counters
      function updateCounters() {
        const currentObservations = window.filteredObservations || [];
        document.getElementById('totalObservations').textContent = currentObservations.length;
        
        const highRiskCount = currentObservations.filter(obs => obs.risk === 'High').length;
        const mediumRiskCount = currentObservations.filter(obs => obs.risk === 'Medium').length;
        const lowRiskCount = currentObservations.filter(obs => obs.risk === 'Low').length;
        
        document.getElementById('highRiskCount').textContent = highRiskCount;
        document.getElementById('mediumRiskCount').textContent = mediumRiskCount;
        document.getElementById('lowRiskCount').textContent = lowRiskCount;
      }
      
      
      
      function formatDate(dateString) {
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return new Date(dateString).toLocaleDateString(undefined, options);
      }
      
      function formatTime(dateString) {
        const options = { hour: '2-digit', minute: '2-digit' };
        return new Date(dateString).toLocaleTimeString(undefined, options);
      }
      
      // Load saved assessor if exists
      const savedAssessor = localStorage.getItem('hseAssessor');
      if (savedAssessor) {
        assessorData = JSON.parse(savedAssessor);
        inspectorSelect.innerHTML = `
          <option disabled selected value="">Select Inspector</option>
          <option selected value="${assessorData.name}">${assessorData.name}</option>
        `;
      }
    });
</script>
  <!-- Toast Container for Logout Notification -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="toastContainer"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Image Expansion Modal -->
  <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="imageModalLabel">Observation Photo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <img src="" id="expandedImage" class="img-fluid" alt="Expanded Observation Photo">
        </div>
      </div>
    </div>
  </div>

<script>
  // Main App Initialization
  async function initApp() {
    // All initializations will be consolidated here.
    const result = await testConnection();
    if (result.connected && !result.tablesExist) {
      console.log('Ready to create tables - run the SQL schema in Supabase dashboard');
      showNotification('Supabase connected. Schema not found. Please run the setup SQL.', 'warning', 7000);
    } else if (!result.connected) {
      showNotification('Failed to connect to Supabase. Check credentials and network.', 'danger', 7000);
    }

    // Load initial observations
    await refreshObservations();

    // Initialize and handle image expansion modal
    const imageModalEl = document.getElementById('imageModal');
    if (imageModalEl) {
      const imageModal = new bootstrap.Modal(imageModalEl);
      const expandedImage = document.getElementById('expandedImage');
      const observationsList = document.getElementById('observationsList');

      observationsList.addEventListener('click', (event) => {
        if (event.target.classList.contains('card-img-top')) {
          const fullSrc = event.target.dataset.fullSrc;
          console.log('Image URL for modal:', fullSrc);
          if (fullSrc) {
            expandedImage.src = fullSrc;
            imageModal.show();
          } else {
            console.error('No full source URL found for the clicked image.');
          }
        }
      });
    }

    // Manual refresh button
    const refreshBtn = document.getElementById('refreshData');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', async () => {
        console.log('Manual data refresh triggered.');
        // Add a visual indicator for loading
        refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Refreshing...';
        refreshBtn.disabled = true;
        try {
          await refreshObservations();
        } catch (error) {
          console.error('Error during manual refresh:', error);
        } finally {
          // Restore button state
          refreshBtn.innerHTML = 'Refresh Data';
          refreshBtn.disabled = false;
        }
      });
    }

    // Setup filter event listeners
    const filterControls = ['filterHighRisk', 'filterMediumRisk', 'filterLowRisk', 'dateRangeFilter', 'searchObservations'];
    filterControls.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        const eventType = (id === 'searchObservations') ? 'input' : 'change';
        el.addEventListener(eventType, () => window.applyFilters());
      }
    });

    const resetBtn = document.getElementById('resetFilters');
    if (resetBtn) {
      resetBtn.addEventListener('click', () => {
        const searchEl = document.getElementById('searchObservations');
        if (searchEl) searchEl.value = '';

        const highEl = document.getElementById('filterHighRisk');
        if (highEl) highEl.checked = true;
        const medEl = document.getElementById('filterMediumRisk');
        if (medEl) medEl.checked = true;
        const lowEl = document.getElementById('filterLowRisk');
        if (lowEl) lowEl.checked = true;

        window.applyFilters();
      });
    }
  }

  document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
<!-- Observation Detail Modal -->
<div class="modal fade" id="observationDetailModal" tabindex="-1" aria-labelledby="observationDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="observationDetailModalLabel">Observation Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>Location:</strong> <span id="modalLocation"></span></p>
            <p><strong>Date:</strong> <span id="modalDate"></span></p>
            <p><strong>Risk Level:</strong> <span id="modalRisk"></span></p>
          </div>
          <div class="col-md-6">
            <p><strong>Responsible:</strong> <span id="modalResponsible"></span></p>
            <p><strong>Inspector:</strong> <span id="modalInspector"></span></p>
          </div>
        </div>
        <hr>
        <h6>Observation</h6>
        <p id="modalObservationText"></p>
        <h6>Action Taken</h6>
        <p id="modalActionTaken"></p>
        <hr>
        <h6>Photos</h6>
        <div id="modalPhotos" class="row">
          <!-- Photos will be injected here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
